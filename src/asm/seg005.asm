; Generated by restunts-export.py (Ghidra)
.8086
.model medium

include seg005.inc

seg005 segment byte public use16 'STUNTSC'
    assume cs:seg005, es:nothing, ss:nothing, ds:dseg

    db 0x90

; void __cdecl16far run_game(void)
run_game_asm_ proc far
    var_16     = dword ptr -22
    var_12     = word ptr  -18
    var_E      = word ptr  -14
    var_C      = word ptr  -12
    var_rect   = byte ptr  -10
    var_2      = word ptr   -2

    push    bp
    mov     bp, sp
    sub     sp, 0x16
    push    si
    mov     word ptr [bp+var_C], 0xffff
    mov     word ptr [rect_windshield], 0x0
    mov     word ptr [rect_windshield.rc_right], 0x140
    mov     word ptr [bp+var_2], 0xffff
    mov     word ptr [word_449EA], 0xffff
    call    far ptr get_kevinrandom
    mov     cl, 0x3
    shl     ax, cl
    mov     word ptr [run_game_random], ax
    mov     byte ptr [replaybar_toggle], 0x1
    mov     byte ptr [is_in_replay], 0x0
    cmp     byte ptr [idle_expired], 0x0
    jz      LAB_21b7_007c
    inc     byte ptr [cameramode]
    cmp     byte ptr [cameramode], 0x4
    jnz     LAB_21b7_005a
    mov     byte ptr [cameramode], 0x0
LAB_21b7_005a:
    mov     byte ptr [game_replay_mode], 0x2
    mov     ax, offset aDefault
    push    ax
    sub     ax, ax
    push    ax                                 ; char *
    push    cs
    call    near ptr file_load_replay
    add     sp, 0x4
    or      al, al
    jz      LAB_21b7_0074
    jmp     near ptr LAB_21b7_0884
LAB_21b7_0074:
    call    far ptr track_setup
    jmp     LAB_21b7_009f
    db 0x90
LAB_21b7_007c:
    cmp     word ptr [gameconfig.game_recordedframes], 0x0
    jnz     LAB_21b7_0090
    mov     byte ptr [cameramode], 0x0
    mov     byte ptr [game_replay_mode], 0x1
    jmp     LAB_21b7_009f
    db 0x90
LAB_21b7_0090:
    mov     byte ptr [cameramode], 0x0
    mov     byte ptr [game_replay_mode], 0x2
    mov     byte ptr [is_in_replay], 0x1
LAB_21b7_009f:
    push    cs
    call    near ptr setup_player_cars
    or      ax, ax
    jz      LAB_21b7_00b4
    push    cs
    call    near ptr free_player_cars
    call    far ptr do_mer_restext
    jmp     near ptr LAB_21b7_0874
    db 0x90
LAB_21b7_00b4:
    mov     byte ptr [kbormouse], 0x0
    mov     byte ptr [byte_449E6], 0x0
    mov     byte ptr [byte_449DA], 0x1
    push    cs
    call    near ptr set_frame_callback
    mov     byte ptr [game_replay_mode_copy], 0xff
    mov     byte ptr [byte_44346], 0x0
    mov     byte ptr [byte_4432A], 0x0
    mov     byte ptr [byte_46467], 0x0
    mov     byte ptr [dashb_toggle], 0x0
    cmp     byte ptr [idle_expired], 0x0
    jz      LAB_21b7_00fe
    mov     al, byte ptr [gameconfig.game_framespersec]
    cbw
    mov     word ptr [framespersec], ax
LAB_21b7_00ee:
    mov     ax, 0xffff
    push    ax
    call    far ptr init_game_state
    add     sp, 0x2
    jmp     near ptr LAB_21b7_0232
    db 0x90
LAB_21b7_00fe:
    cmp     byte ptr [is_in_replay], 0x0
    jz      LAB_21b7_0108
    jmp     near ptr LAB_21b7_01bc
LAB_21b7_0108:
    mov     byte ptr [cameramode], 0x0
    mov     byte ptr [dashb_toggle], 0x1
    mov     byte ptr [show_penalty_counter], 0x0
    mov     ax, word ptr [framespersec2]
    mov     word ptr [framespersec], ax
    mov     al, byte ptr [framespersec2]
    mov     byte ptr [gameconfig.game_framespersec], al
    mov     ax, 0xffff
    push    ax
    call    far ptr init_game_state
    add     sp, 0x2
    mov     word ptr [word_45D94], 0x0
    mov     byte ptr [word_45D3E], 0x0
    mov     byte ptr [byte_4393C], 0x1
    mov     al, byte ptr [byte_3B8F2]
    cbw
    push    ax
    push    cs
    call    near ptr mouse_minmax_position
    add     sp, 0x2
    mov     byte ptr [game_replay_mode], 0x1
    mov     ax, 0xff10
    push    ax
    push    word ptr [track_angle]
    call    far ptr sin_fast
    add     sp, 0x2
    push    ax
    call    far ptr multiply_and_scale
    add     sp, 0x4
    cwd
    mov     cl, 0x6
LAB_21b7_016c:
    shl     ax, 0x1
    rcl     dx, 0x1
    dec     cl
    jnz     LAB_21b7_016c
    add     word ptr [state.playerstate.car_posWorld1.lx], ax
    adc     word ptr [state.playerstate.car_posWorld1.lx+2], dx
    mov     ax, 0xff10                         ; -240
    push    ax
    push    word ptr [track_angle]
    call    far ptr cos_fast
    add     sp, 0x2
    push    ax
    call    far ptr multiply_and_scale
    add     sp, 0x4
    cwd
    mov     cl, 0x6
LAB_21b7_0198:
    shl     ax, 0x1
    rcl     dx, 0x1
    dec     cl
    jnz     LAB_21b7_0198
    add     word ptr [state.playerstate.car_posWorld1.lz], ax
    adc     word ptr [state.playerstate.car_posWorld1.lz+2], dx
    add     word ptr [state.playerstate.car_posWorld1.ly], 0x580
    adc     word ptr [state.playerstate.car_posWorld1.ly+2], 0x0
    mov     byte ptr [byte_43966], 0x1
    jmp     LAB_21b7_0232
    db 0x90
    db 0x90
LAB_21b7_01bc:
    mov     byte ptr [cameramode], 0x0
    mov     byte ptr [game_replay_mode], 0x2
    mov     word ptr [word_44DCA], 0x1f4
    mov     al, byte ptr [gameconfig.game_framespersec]
    cbw
    mov     word ptr [framespersec], ax
    sub     ax, ax
    push    ax
    call    far ptr restore_gamestate
    add     sp, 0x2
    push    word ptr [gameconfig.game_recordedframes]
    call    far ptr restore_gamestate
    add     sp, 0x2
    jmp     LAB_21b7_0202
LAB_21b7_01ec:
    mov     ax, 0x1
    push    ax
    call    far ptr input_do_checking
    add     sp, 0x2
    cmp     ax, 0x1b
    jz      LAB_21b7_020b
    call    far ptr update_gamestate
LAB_21b7_0202:
    mov     ax, word ptr [state.game_frame]
    cmp     word ptr [gameconfig.game_recordedframes], ax
    jnz     LAB_21b7_01ec
LAB_21b7_020b:
    mov     ax, word ptr [gameconfig.game_recordedframes]
    mov     word ptr [elapsed_time2], ax
    jmp     LAB_21b7_0232
    db 0x90
LAB_21b7_0214:
    cmp     byte ptr [byte_3B8F2], 0x0
    jnz     LAB_21b7_0222
    cmp     byte ptr [byte_3FE00], 0x0
    jz      LAB_21b7_022d
LAB_21b7_0222:
    cmp     byte ptr [game_replay_mode], 0x0
    jnz     LAB_21b7_022d
    push    cs
    call    near ptr replay_unk
LAB_21b7_022d:
    call    far ptr update_gamestate
LAB_21b7_0232:
    mov     ax, word ptr [elapsed_time2]
    cmp     word ptr [state.game_frame], ax
    jnz     LAB_21b7_0214
    cmp     byte ptr [game_replay_mode], 0x0
    jnz     LAB_21b7_025b
    cmp     byte ptr [byte_449DA], 0x0
    jnz     LAB_21b7_025b
    cmp     byte ptr [state.game_inputmode], 0x0
    jz      LAB_21b7_025b
    mov     ax, word ptr [state.game_frame]
    cmp     word ptr [bp+var_C], ax
    jz      LAB_21b7_0232
    mov     word ptr [bp+var_C], ax
LAB_21b7_025b:
    cmp     byte ptr [state.game_inputmode], 0x0
    jnz     LAB_21b7_027b
    cmp     byte ptr [game_replay_mode], 0x0
    jnz     LAB_21b7_027b
    mov     word ptr [elapsed_time2], 0x0
    mov     word ptr [gameconfig.game_recordedframes], 0x0
    mov     word ptr [state.game_frame], 0x0
LAB_21b7_027b:
    mov     ax, word ptr [slow_video_mgmt]
    cmp     word ptr [slow_video_mgmt_copy], ax
    jz      LAB_21b7_028c
    mov     word ptr [slow_video_mgmt_copy], ax
    call    far ptr init_rect_arrays
LAB_21b7_028c:
    cmp     byte ptr [byte_46467], 0x0
    jz      LAB_21b7_0306
    call    far ptr input_push_status
    call    far ptr audio_unk
    sub     ax, ax
    push    ax
    push    ax
    push    word ptr [dialogarg2]
    mov     ax, 0xffff
    push    ax
    push    ax
    mov     ax, offset aRbf
    push    ax
    push    word ptr [gameresptr+2]
    push    word ptr [gameresptr]
    call    far ptr locate_text_res
    add     sp, 0x6
    push    dx
    push    ax
    mov     ax, 0x1
    push    ax
    mov     ax, 0x2
    push    ax
    call    far ptr show_dialog
    add     sp, 0x12
    mov     si, ax
    cmp     si, -0x1
    jnz     LAB_21b7_02d9
    sub     si, si
LAB_21b7_02d9:
    call    far ptr sub_372F4
    mov     word ptr [word_3F88E], 0x0
    call    far ptr input_pop_status
    or      si, si
    jz      LAB_21b7_0301
    sub     ax, ax
    push    ax
    mov     ax, 0x4
    push    ax
    call    far ptr update_crash_state
    add     sp, 0x4
    mov     byte ptr [byte_449DA], 0x1
LAB_21b7_0301:
    mov     byte ptr [byte_46467], 0x0
LAB_21b7_0306:
    cmp     byte ptr [video_flag5_is0], 0x0
    jz      LAB_21b7_031a
    call    far ptr setup_mcgawnd2
    mov     al, byte ptr [byte_44346]
    mov     byte ptr [byte_4432A], al
    jmp     LAB_21b7_031f
LAB_21b7_031a:
    call    far ptr sprite_copy_wnd_to_1
LAB_21b7_031f:
    mov     al, byte ptr [game_replay_mode_copy]
    cmp     byte ptr [game_replay_mode], al
    jnz     LAB_21b7_034f
    mov     al, byte ptr [dashb_toggle_copy]
    cmp     byte ptr [dashb_toggle], al
    jnz     LAB_21b7_034f
    mov     al, byte ptr [replaybar_toggle_copy]
    cmp     byte ptr [replaybar_toggle], al
    jnz     LAB_21b7_034f
    mov     al, byte ptr [is_in_replay_copy]
    cmp     byte ptr [is_in_replay], al
    jnz     LAB_21b7_034f
    mov     al, byte ptr [followOpponentFlag_copy]
    cmp     byte ptr [followOpponentFlag], al
    jnz     LAB_21b7_034f
    jmp     near ptr LAB_21b7_040a
LAB_21b7_034f:
    mov     al, byte ptr [game_replay_mode]
    mov     byte ptr [game_replay_mode_copy], al
    mov     al, byte ptr [dashb_toggle]
    mov     byte ptr [dashb_toggle_copy], al
    mov     al, byte ptr [replaybar_toggle]
    mov     byte ptr [replaybar_toggle_copy], al
    mov     al, byte ptr [is_in_replay]
    mov     byte ptr [is_in_replay_copy], al
    mov     al, byte ptr [followOpponentFlag]
    mov     byte ptr [followOpponentFlag_copy], al
    mov     word ptr [roofbmpheight_copy], 0x0
    mov     byte ptr [byte_449E2], 0x0
    cmp     byte ptr [game_replay_mode], 0x2
    jnz     LAB_21b7_039a
    cmp     byte ptr [idle_expired], 0x0
    jnz     LAB_21b7_039a
    cmp     byte ptr [replaybar_toggle], 0x0
    jz      LAB_21b7_0390
    jmp     near ptr LAB_21b7_047e
LAB_21b7_0390:
    cmp     byte ptr [is_in_replay], 0x0
    jz      LAB_21b7_039a
    jmp     near ptr LAB_21b7_047e
LAB_21b7_039a:
    mov     byte ptr [replaybar_enabled], 0x0
LAB_21b7_039f:
    cmp     byte ptr [idle_expired], 0x0
    jnz     LAB_21b7_03a9
    jmp     near ptr LAB_21b7_0486
LAB_21b7_03a9:
    mov     word ptr [dashbmp_y_copy], 0xc8
LAB_21b7_03af:
    mov     ax, word ptr [roofbmpheight_copy]
    cmp     word ptr [bp+var_2], ax
    jnz     LAB_21b7_03c8
    mov     ax, word ptr [word_449EA]
    cmp     word ptr [dashbmp_y_copy], ax
    jnz     LAB_21b7_03c8
    mov     ax, word ptr [height_above_replaybar]
    cmp     word ptr [bp+var_E], ax
    jz      LAB_21b7_040a
LAB_21b7_03c8:
    mov     al, byte ptr [video_flag6_is1]
    mov     byte ptr [byte_454A4], al
    push    word ptr [dashbmp_y_copy]
    mov     ax, 0x140
    push    ax
    mov     ax, word ptr [dashbmp_y_copy]
    cwd
    mov     cx, 0x6
    idiv    cx
    push    ax
    mov     ax, 0x23
    push    ax
    call    far ptr set_projection
    add     sp, 0x8
    mov     ax, word ptr [roofbmpheight_copy]
    mov     word ptr [rect_windshield.rc_top], ax
    mov     ax, word ptr [dashbmp_y_copy]
    mov     word ptr [rect_windshield.rc_bottom], ax
    mov     ax, word ptr [roofbmpheight_copy]
    mov     word ptr [bp+var_2], ax
    mov     ax, word ptr [dashbmp_y_copy]
    mov     word ptr [word_449EA], ax
    mov     ax, word ptr [height_above_replaybar]
    mov     word ptr [bp+var_E], ax
LAB_21b7_040a:
    cmp     byte ptr [byte_454A4], 0x0
    jnz     LAB_21b7_0414
    jmp     near ptr LAB_21b7_04e2
LAB_21b7_0414:
    mov     al, byte ptr [byte_4432A]
    cbw
    mov     bx, ax
    mov     byte ptr [bx+byte_449D8], 0x0
    cmp     byte ptr [byte_449E2], 0x0
    jz      LAB_21b7_0448
    push    word ptr [height_above_replaybar]
    push    word ptr [dashbmp_y_copy]
    mov     ax, 0x140
    push    ax
    sub     ax, ax
    push    ax
    call    far ptr sprite_set_1_size
    add     sp, 0x8
    mov     ax, 0x1
    push    ax
    push    cs
    call    near ptr setup_car_shapes
    add     sp, 0x2
LAB_21b7_0448:
    cmp     byte ptr [replaybar_enabled], 0x0
    jnz     LAB_21b7_0452
    jmp     near ptr LAB_21b7_04f4
LAB_21b7_0452:
    mov     ax, 0xc8
    push    ax
    sub     ax, ax
    push    ax
    mov     ax, 0x140
    push    ax
    sub     ax, ax
    push    ax
    call    far ptr sprite_set_1_size
    add     sp, 0x8
    push    word ptr [state.game_frame]
    push    word ptr [state.game_frame]
    mov     ax, 0x1
    push    ax
    push    cs
    call    near ptr loop_game
    add     sp, 0x6
    jmp     LAB_21b7_04f4
    db 0x90
LAB_21b7_047e:
    mov     byte ptr [replaybar_enabled], 0x1
    jmp     near ptr LAB_21b7_039f
LAB_21b7_0486:
    cmp     byte ptr [dashb_toggle], 0x0
    jz      LAB_21b7_04c4
    cmp     byte ptr [followOpponentFlag], 0x0
    jnz     LAB_21b7_04c4
    cmp     byte ptr [game_replay_mode], 0x2
    jnz     LAB_21b7_04aa
    cmp     byte ptr [replaybar_enabled], 0x0
    jz      LAB_21b7_04aa
    mov     word ptr [height_above_replaybar], 0x97 ; 151 = height of render area above the replay menu bar
    jmp     LAB_21b7_04b0
LAB_21b7_04aa:
    mov     word ptr [height_above_replaybar], 0xc8 ; 200 = height of render area without the replay menu bar
LAB_21b7_04b0:
    mov     byte ptr [byte_449E2], 0x1
    mov     ax, word ptr [roofbmpheight]
    mov     word ptr [roofbmpheight_copy], ax
    mov     ax, word ptr [dashbmp_y]
    mov     word ptr [dashbmp_y_copy], ax
    jmp     near ptr LAB_21b7_03af
LAB_21b7_04c4:
    cmp     byte ptr [game_replay_mode], 0x2
    jz      LAB_21b7_04ce
    jmp     near ptr LAB_21b7_03a9
LAB_21b7_04ce:
    cmp     byte ptr [replaybar_enabled], 0x0
    jnz     LAB_21b7_04d8
    jmp     near ptr LAB_21b7_03a9
LAB_21b7_04d8:
    mov     word ptr [dashbmp_y_copy], 0x97
    jmp     near ptr LAB_21b7_03af
    db 0x90
LAB_21b7_04e2:
    cmp     byte ptr [replaybar_enabled], 0x0
    jnz     LAB_21b7_04f4
    mov     al, byte ptr [byte_4432A]
    cbw
    mov     bx, ax
    mov     byte ptr [bx+byte_449D8], 0x0
LAB_21b7_04f4:
    mov     ax, offset rect_windshield
    push    ax
    mov     al, byte ptr [byte_44346]
    cbw
    push    ax
    call    far ptr update_frame
    add     sp, 0x4
    cmp     word ptr [dastbmp_y], 0x0
    jz      LAB_21b7_056b
    cmp     byte ptr [byte_449E2], 0x0
    jz      LAB_21b7_056b
    cmp     word ptr [slow_video_mgmt_copy], 0x0
    jz      LAB_21b7_054b
    mov     word ptr [bp+var_rect], 0x0
    mov     word ptr [bp+var_rect+2], 0x140
    mov     ax, word ptr [dastbmp_y]
    mov     word ptr [bp+var_rect+4], ax
    mov     ax, word ptr [dashbmp_y_copy]
    mov     word ptr [bp+var_rect+6], ax
    cmp     word ptr [rectptr_unk], 0x0
    jz      LAB_21b7_054b
    push    word ptr [rectptr_unk]
    lea     ax, [bp+var_rect]
    push    ax
    push    word ptr [rectptr_unk]
    call    far ptr rect_union
    add     sp, 0x6
LAB_21b7_054b:
    push    word ptr [dasmshapeptr+2]
    push    word ptr [dasmshapeptr]
    call    far ptr shape2d_render_bmp_as_mask
    add     sp, 0x4
    push    word ptr [dastseg]
    push    word ptr [dastbmp_y2]
    call    far ptr shape2d_op_unk4
    add     sp, 0x4
LAB_21b7_056b:
    mov     ax, offset rect_windshield
    push    ax
    call    far ptr sub_19F14
    add     sp, 0x2
    cmp     byte ptr [byte_449E2], 0x0
    jz      LAB_21b7_05b6
    push    word ptr [height_above_replaybar]
    push    word ptr [dashbmp_y_copy]
    mov     ax, 0x140
    push    ax
    sub     ax, ax
    push    ax
    call    far ptr sprite_set_1_size
    add     sp, 0x8
    mov     ax, 0x2
    push    ax
    push    cs
    call    near ptr setup_car_shapes
    add     sp, 0x2
    mov     ax, 0xc8
    push    ax
    sub     ax, ax
    push    ax
    mov     ax, 0x140
    push    ax
    sub     ax, ax
    push    ax
    call    far ptr sprite_set_1_size
    add     sp, 0x8
LAB_21b7_05b6:
    cmp     byte ptr [byte_454A4], 0x0
    jz      LAB_21b7_05c1
    dec     byte ptr [byte_454A4]
LAB_21b7_05c1:
    cmp     byte ptr [video_flag5_is0], 0x0
    jz      LAB_21b7_05e2
    call    far ptr mouse_draw_opaque_check
    call    far ptr setup_mcgawnd1
    xor     byte ptr [byte_44346], 0x1
    mov     al, byte ptr [byte_44346]
    mov     byte ptr [byte_4432A], al
    call    far ptr mouse_draw_transparent_check
LAB_21b7_05e2:
    cmp     byte ptr [game_replay_mode], 0x1
    jnz     LAB_21b7_060d
    cmp     byte ptr [byte_4393C], 0x0
    jnz     LAB_21b7_060d
    mov     byte ptr [game_replay_mode], 0x0
    mov     ax, word ptr [framespersec2]
    mov     word ptr [framespersec], ax
    mov     al, byte ptr [framespersec2]
    mov     byte ptr [gameconfig.game_framespersec], al
    mov     ax, 0xffff
    push    ax
    call    far ptr init_game_state
    add     sp, 0x2
LAB_21b7_060d:
    cmp     byte ptr [idle_expired], 0x0
    jz      LAB_21b7_063a
    call    far ptr kb_get_char
    or      ax, ax
    jz      LAB_21b7_0620
    jmp     near ptr LAB_21b7_0728
LAB_21b7_0620:
    cmp     byte ptr [byte_449DA], 0x0
    jz      LAB_21b7_062a
    jmp     near ptr LAB_21b7_0728
LAB_21b7_062a:
    call    far ptr get_kb_or_joy_flags
    or      ax, ax
    jnz     LAB_21b7_0636
    jmp     near ptr LAB_21b7_0232
LAB_21b7_0636:
    jmp     near ptr LAB_21b7_0728
    db 0x90
LAB_21b7_063a:
    cmp     byte ptr [byte_449DA], 0x0
    jz      LAB_21b7_0698
    cmp     byte ptr [game_replay_mode], 0x0
    jnz     LAB_21b7_0652
    cmp     byte ptr [state.game_3F6autoLoadEvalFlag], 0x4
    jz      LAB_21b7_0652
    jmp     near ptr LAB_21b7_0728
LAB_21b7_0652:
    cmp     byte ptr [byte_449DA], 0x2
    jnz     LAB_21b7_065c
    jmp     near ptr LAB_21b7_0728
LAB_21b7_065c:
    mov     byte ptr [byte_449DA], 0x0
    mov     byte ptr [game_replay_mode], 0x2
    sub     ax, ax
    push    ax
    push    cs
    call    near ptr mouse_minmax_position
    add     sp, 0x2
    sub     ax, ax
    push    ax
    push    ax
    push    ax
    push    cs
    call    near ptr loop_game
    add     sp, 0x6
    sub     ax, ax
    push    ax
    mov     ax, 0x4
    push    ax
    mov     ax, 0x2
    push    ax
    push    cs
    call    near ptr loop_game
    add     sp, 0x6
    mov     byte ptr [is_in_replay], 0x1
    call    far ptr audio_carstate
LAB_21b7_0698:
    cmp     byte ptr [game_replay_mode], 0x2
    jnz     LAB_21b7_06b2
    sub     ax, ax
    push    ax
    push    ax
    mov     ax, 0x3
    push    ax
    push    cs
    call    near ptr loop_game
    add     sp, 0x6
    jmp     near ptr LAB_21b7_0232
    db 0x90
LAB_21b7_06b2:
    call    far ptr kb_get_char
    mov     word ptr [bp+var_12], ax
    or      ax, ax
    jz      LAB_21b7_06c6
    push    ax
    push    cs
    call    near ptr handle_ingame_kb_shortcuts
    add     sp, 0x2
LAB_21b7_06c6:
    mov     ax, word ptr [bp+var_12]
    cmp     ax, 0x4800
    jz      LAB_21b7_06b2
    cmp     ax, 0x4b00
    jz      LAB_21b7_06b2
    cmp     ax, 0x4d00
    jz      LAB_21b7_06b2
    cmp     ax, 0x5000
    jz      LAB_21b7_06b2
    cmp     byte ptr [game_replay_mode], 0x1
    jz      LAB_21b7_06e7
    jmp     near ptr LAB_21b7_0232
LAB_21b7_06e7:
    mov     ax, offset mouse_ypos
    push    ax
    mov     ax, offset mouse_xpos
    push    ax
    mov     ax, offset mouse_butstate
    push    ax
    call    far ptr mouse_get_state
    add     sp, 0x6
    test    byte ptr [mouse_butstate], 0x3
    jnz     LAB_21b7_070e
    call    far ptr get_kb_or_joy_flags
    test    al, 0x30
    jnz     LAB_21b7_070e
    jmp     near ptr LAB_21b7_0232
LAB_21b7_070e:
    mov     byte ptr [game_replay_mode], 0x0
    mov     byte ptr [byte_4393C], 0x0
    mov     ax, word ptr [framespersec2]
    mov     word ptr [framespersec], ax
    mov     al, byte ptr [framespersec2]
    mov     byte ptr [gameconfig.game_framespersec], al
    jmp     near ptr LAB_21b7_00ee
    db 0x90
LAB_21b7_0728:
    cmp     byte ptr [video_flag5_is0], 0x0
    jz      LAB_21b7_0763
    call    far ptr get_0
    or      ax, ax
    jz      LAB_21b7_0763
    call    far ptr mouse_draw_opaque_check
    call    far ptr setup_mcgawnd2
    sub     ax, ax
    push    ax
    mov     ax, 0xc8                           ; 200
    push    ax
    mov     ax, 0x140                          ; 320
    push    ax
    sub     ax, ax
    push    ax
    push    ax
    call    far ptr sub_35C4E
    add     sp, 0xa
    call    far ptr setup_mcgawnd1
    call    far ptr mouse_draw_transparent_check
LAB_21b7_0763:
    call    far ptr sprite_copy_2_to_1_2
    mov     byte ptr [is_in_replay], 0x1
    call    far ptr audio_carstate
    call    far ptr audio_remove_driver_timer
    cmp     byte ptr [game_replay_mode], 0x0
    jz      LAB_21b7_0781
    jmp     near ptr LAB_21b7_085d
LAB_21b7_0781:
    cmp     byte ptr [gameconfig.game_opponenttype], 0x0
    jnz     LAB_21b7_078b
    jmp     near ptr LAB_21b7_085d
LAB_21b7_078b:
    cmp     byte ptr [state.opponentstate.car_crashBmpFlag], 0x0
    jz      LAB_21b7_0795
    jmp     near ptr LAB_21b7_085d
LAB_21b7_0795:
    sub     ax, ax
    push    ax
    lea     ax, [bp+var_16]
    push    ax
    push    word ptr [performGraphColor]
    mov     ax, 0x50
    push    ax
    mov     ax, 0xffff
    push    ax
    mov     ax, offset aCop
    push    ax
    push    word ptr [gameresptr+2]
    push    word ptr [gameresptr]
    call    far ptr locate_text_res
    add     sp, 0x6
    push    dx
    push    ax
    sub     ax, ax
    push    ax
    mov     ax, 0x3
    push    ax
    call    far ptr show_dialog
    add     sp, 0x12
    mov     byte ptr [word_45D3E], 0x1
    mov     si, word ptr [framespersec]
    dec     si
LAB_21b7_07d7:
    mov     ax, 0x1
    push    ax
    push    cs
    call    near ptr replay_unk2
    add     sp, 0x2
    call    far ptr update_gamestate
    inc     si
    mov     ax, word ptr [framespersec]
    cmp     si, ax
    jnz     LAB_21b7_082f
    sub     si, si
    mov     ax, 0x1
    push    ax                                 ; int
    mov     ax, word ptr [state.game_frame]
    add     ax, word ptr [elapsed_time1]
    push    ax
    mov     ax, offset g_res_id
    push    ax                                 ; char *
    call    far ptr format_frame_as_string
    add     sp, 0x6
    call    far ptr mouse_draw_opaque_check
    push    word ptr [bp+var_16+2]
    mov     ax, offset g_res_id
    push    ax
    call    far ptr font_op2_alt
    add     sp, 0x2
    push    ax
    mov     ax, offset g_res_id
    push    ax
    call    far ptr sub_345BC
    add     sp, 0x6
    call    far ptr mouse_draw_transparent_check
LAB_21b7_082f:
    mov     ax, 0x1
    push    ax
    call    far ptr input_do_checking
    add     sp, 0x2
    cmp     ax, 0x1b
    jz      LAB_21b7_085d
    cmp     byte ptr [state.opponentstate.car_crashBmpFlag], 0x0
    jnz     LAB_21b7_085d
    mov     ax, 0x5dc
    imul    word ptr [framespersec]
    mov     cx, word ptr [state.game_frame]
    add     cx, word ptr [elapsed_time1]
    cmp     ax, cx
    jz      LAB_21b7_085d
    jmp     near ptr LAB_21b7_07d7
LAB_21b7_085d:
    mov     byte ptr [word_45D3E], 0x0
    sub     ax, ax
    push    ax
    push    cs
    call    near ptr mouse_minmax_position
    add     sp, 0x2
    push    cs
    call    near ptr remove_frame_callback
    push    cs
    call    near ptr free_player_cars
LAB_21b7_0874:
    mov     word ptr [waitflag], 0x64
    call    far ptr check_input
    call    far ptr show_waiting
LAB_21b7_0884:
    pop     si
    mov     sp, bp
    pop     bp
    retf
run_game_asm_ endp
    db 0x90

; int __cdecl16far handle_ingame_kb_shortcuts(uint key)
handle_ingame_kb_shortcuts_asm_ proc far
    key        = word ptr    6

    push    bp
    mov     bp, sp
    mov     ax, word ptr [bp+key]
    cmp     ax, 0x64
    jz      LAB_21b7_0900
    jbe     LAB_21b7_089a
    jmp     near ptr LAB_21b7_097e
LAB_21b7_089a:
    cmp     ax, 0x44
    jz      LAB_21b7_0900
    jbe     LAB_21b7_08a4
    jmp     near ptr LAB_21b7_093c
LAB_21b7_08a4:
    cmp     ax, 0x1b                           ; ESC
    jz      LAB_21b7_08b0
    cmp     ax, 0x43
    jmp     near ptr LAB_21b7_094e
    db 0x90
LAB_21b7_08b0:
    cmp     byte ptr [game_replay_mode], 0x0
    jnz     LAB_21b7_08c6
    sub     ax, ax
    push    ax
    mov     ax, 0x4
    push    ax
    call    far ptr update_crash_state
    add     sp, 0x4
LAB_21b7_08c6:
    mov     byte ptr [byte_449DA], 0x1
    jmp     near ptr LAB_21b7_0979
LAB_21b7_08ce:
    mov     byte ptr [cameramode], 0x1
    jmp     near ptr LAB_21b7_0979
LAB_21b7_08d6:
    mov     byte ptr [cameramode], 0x2
    jmp     near ptr LAB_21b7_0979
LAB_21b7_08de:
    mov     byte ptr [cameramode], 0x3
    jmp     near ptr LAB_21b7_0979
LAB_21b7_08e6:
    xor     byte ptr [HKeyFlag], 0x1
    jmp     near ptr LAB_21b7_0979
LAB_21b7_08ee:
    call    far ptr do_mou_restext
    mov     al, byte ptr [byte_3B8F2]
    cbw
    push    ax
    push    cs
    call    near ptr mouse_minmax_position
    jmp     LAB_21b7_0976
    db 0x90
    db 0x90
LAB_21b7_0900:
    xor     byte ptr [dashb_toggle], 0x1
    jmp     LAB_21b7_0979
    db 0x90
LAB_21b7_0908:
    xor     byte ptr [replaybar_toggle], 0x1
    jmp     LAB_21b7_0979
    db 0x90
LAB_21b7_0910:
    cmp     byte ptr [game_replay_mode], 0x1
    jz      LAB_21b7_0979
    inc     byte ptr [cameramode]
    cmp     byte ptr [cameramode], 0x4
    jnz     LAB_21b7_0979
LAB_21b7_0922:
    mov     byte ptr [cameramode], 0x0
    jmp     LAB_21b7_0979
    db 0x90
LAB_21b7_092a:
    cmp     byte ptr [gameconfig.game_opponenttype], 0x0
    jz      LAB_21b7_0979
    xor     byte ptr [followOpponentFlag], 0x1
    jmp     LAB_21b7_0979
LAB_21b7_0938:
    sub     ax, ax
    pop     bp
    retf
LAB_21b7_093c:
    cmp     ax, 0x48
    jz      LAB_21b7_08e6
    cmp     ax, 0x4d
    jz      LAB_21b7_08ee
    cmp     ax, 0x52
    jz      LAB_21b7_0908
    cmp     ax, 0x63
LAB_21b7_094e:
    jz      LAB_21b7_0910
LAB_21b7_0950:
    cmp     byte ptr [game_replay_mode], 0x1
    jnz     LAB_21b7_0938
    mov     byte ptr [game_replay_mode], 0x0
    mov     byte ptr [byte_4393C], 0x0
    mov     ax, word ptr [framespersec2]
    mov     word ptr [framespersec], ax
    mov     al, byte ptr [framespersec2]
    mov     byte ptr [gameconfig.game_framespersec], al
    mov     ax, 0xffff
    push    ax
    call    far ptr init_game_state
LAB_21b7_0976:
    add     sp, 0x2
LAB_21b7_0979:
    mov     ax, 0x1
    pop     bp
    retf
LAB_21b7_097e:
    cmp     ax, 0x74
    jz      LAB_21b7_092a
    ja      LAB_21b7_09a0
    cmp     ax, 0x68
    jnz     LAB_21b7_098d
    jmp     near ptr LAB_21b7_08e6
LAB_21b7_098d:
    cmp     ax, 0x6d
    jnz     LAB_21b7_0995
    jmp     near ptr LAB_21b7_08ee
LAB_21b7_0995:
    cmp     ax, 0x72
    jnz     LAB_21b7_099d
    jmp     near ptr LAB_21b7_0908
LAB_21b7_099d:
    jmp     LAB_21b7_0950
    db 0x90
LAB_21b7_09a0:
    cmp     ax, 0x3b00
    jnz     LAB_21b7_09a8
    jmp     near ptr LAB_21b7_0922
LAB_21b7_09a8:
    cmp     ax, 0x3c00
    jnz     LAB_21b7_09b0
    jmp     near ptr LAB_21b7_08ce
LAB_21b7_09b0:
    cmp     ax, 0x3d00
    jnz     LAB_21b7_09b8
    jmp     near ptr LAB_21b7_08d6
LAB_21b7_09b8:
    cmp     ax, 0x3e00
    jnz     LAB_21b7_09c0
    jmp     near ptr LAB_21b7_08de
LAB_21b7_09c0:
    jmp     LAB_21b7_0950
handle_ingame_kb_shortcuts_asm_ endp

; void __cdecl16far init_unknown(void)
init_unknown_asm_ proc far
    push    bp
    mov     bp, sp
    sub     sp, 0x2
    push    si
    mov     byte ptr [byte_44A8A], 0x1
    mov     byte ptr [byte_4552F], 0x2
    sub     si, si
    mov     word ptr [elapsed_time2], si
    sub     al, al
    mov     byte ptr [byte_449DA], al
    mov     byte ptr [byte_4393C], al
    mov     word ptr [word_44DCA], si
    pop     si
    mov     sp, bp
    pop     bp
    retf
init_unknown_asm_ endp

; void __cdecl16far set_frame_callback(void)
set_frame_callback_asm_ proc far
    mov     word ptr [word_46468], 0x0
    mov     ax, offset frame_callback
; <REPLACE>
    mov     dx, seg seg005
; </REPLACE>
;    mov     dx, 0x21b7                         ; seg005
    push    dx
    push    ax
    call    far ptr timer_reg_callback
    add     sp, 0x4
    mov     byte ptr [byte_442E4], 0x0
    retf
set_frame_callback_asm_ endp

; void __cdecl16far remove_frame_callback(void)
remove_frame_callback_asm_ proc far
    mov     ax, 0xa
    cwd
    push    dx
    push    ax
    call    far ptr timer_get_counter_unk
    add     sp, 0x4
    mov     ax, offset frame_callback
; <REPLACE>
    mov     dx, seg seg005
; </REPLACE>
;    mov     dx, 0x21b7
    push    dx
    push    ax
    call    far ptr timer_remove_callback
    add     sp, 0x4
    retf
remove_frame_callback_asm_ endp
    db 0x90

; void __cdecl16far frame_callback(void)
frame_callback_asm_ proc far
    call    far ptr compare_ds_ss
    or      ax, ax
    jnz     LAB_21b7_0a32
    jmp     near ptr LAB_21b7_0b26
LAB_21b7_0a32:
    cmp     byte ptr [byte_442E4], 0x0
    jz      LAB_21b7_0a3c
    jmp     near ptr LAB_21b7_0b26
LAB_21b7_0a3c:
    inc     byte ptr [byte_442E4]
    cmp     byte ptr [byte_442E4], 0x1
    jz      LAB_21b7_0a4a
    jmp     near ptr LAB_21b7_0b22
LAB_21b7_0a4a:
    inc     word ptr [word_443F4]
    mov     ax, word ptr [word_4499C]
    cmp     word ptr [word_443F4], ax
    jl      LAB_21b7_0a8e
    mov     ax, word ptr [word_449E4]
    cmp     word ptr [word_44D1E], ax
    jz      LAB_21b7_0a8e
    push    word ptr [word_443F4]
    mov     ax, 0x22
    imul    word ptr [word_44D1E]
    add     ax, 0x97dc
    push    ax
    call    far ptr sub_18D06
    add     sp, 0x4
    mov     word ptr [word_443F4], 0x0
    inc     word ptr [word_44D1E]
    cmp     word ptr [word_44D1E], 0x28
    jnz     LAB_21b7_0a8e
    mov     word ptr [word_44D1E], 0x0
LAB_21b7_0a8e:
    cmp     byte ptr [byte_449DA], 0x0
    jz      LAB_21b7_0a98
    jmp     near ptr LAB_21b7_0b22
LAB_21b7_0a98:
    cmp     byte ptr [byte_46467], 0x0
    jz      LAB_21b7_0aa2
    jmp     near ptr LAB_21b7_0b22
LAB_21b7_0aa2:
    cmp     byte ptr [is_in_replay], 0x0
    jz      LAB_21b7_0ab0
    cmp     byte ptr [game_replay_mode], 0x2
    jz      LAB_21b7_0b22
LAB_21b7_0ab0:
    cmp     byte ptr [game_replay_mode], 0x0
    jnz     LAB_21b7_0ace
    mov     ax, word ptr [state.game_frames_per_sec]
    cmp     word ptr [state.game_frame_in_sec], ax
    jl      LAB_21b7_0ace
    mov     byte ptr [is_in_replay], 0x1
    call    far ptr audio_carstate
    jmp     LAB_21b7_0b22
    db 2 dup (0x90)
LAB_21b7_0ace:
    dec     byte ptr [byte_44A8A]
    jnz     LAB_21b7_0b22
    mov     al, byte ptr [word_4499C]
    mov     byte ptr [byte_44A8A], al
    inc     word ptr [word_46468]
    cmp     byte ptr [game_replay_mode], 0x2
    jnz     LAB_21b7_0b18
    mov     al, byte ptr [byte_449E6]
    cbw
    cmp     ax, 0x2
    jz      LAB_21b7_0af6
    cmp     ax, 0x3
    jz      LAB_21b7_0b0e
    jmp     LAB_21b7_0b18
    db 0x90
LAB_21b7_0af6:
    dec     byte ptr [byte_4552F]
    jnz     LAB_21b7_0b22
    sub     ax, ax
    push    ax
    push    cs
    call    near ptr replay_unk2
    add     sp, 0x2
    mov     byte ptr [byte_4552F], 0x2
    jmp     LAB_21b7_0b22
    db 0x90
LAB_21b7_0b0e:
    sub     ax, ax
    push    ax
    push    cs
    call    near ptr replay_unk2
    add     sp, 0x2
LAB_21b7_0b18:
    sub     ax, ax
    push    ax
    push    cs
    call    near ptr replay_unk2
    add     sp, 0x2
LAB_21b7_0b22:
    dec     byte ptr [byte_442E4]
LAB_21b7_0b26:
    retf
frame_callback_asm_ endp
    db 0x90

; void __cdecl16far replay_unk2(int param_1)
replay_unk2_asm_ proc far
    var_A      = word ptr  -10
    var_8      = word ptr   -8
    var_6      = word ptr   -6
    param_1    = word ptr    6

    push    bp
    mov     bp, sp
    sub     sp, 0xa
    push    di
    push    si
    cmp     word ptr [bp+param_1], 0x0
    jz      LAB_21b7_0b3c
LAB_21b7_0b36:
    sub     si, si
    jmp     near ptr LAB_21b7_0ca7
    db 0x90
LAB_21b7_0b3c:
    cmp     byte ptr [game_replay_mode], 0x2
    jnz     LAB_21b7_0b76
    mov     ax, word ptr [elapsed_time2]
    cmp     word ptr [gameconfig.game_recordedframes], ax
    jbe     LAB_21b7_0b56
    inc     word ptr [elapsed_time2]
    pop     si
    pop     di
    mov     sp, bp
    pop     bp
    retf
LAB_21b7_0b56:
    cmp     byte ptr [byte_449DA], 0x0
    jz      LAB_21b7_0b60
    jmp     near ptr LAB_21b7_0e15
LAB_21b7_0b60:
    mov     byte ptr [is_in_replay], 0x1
    call    far ptr audio_carstate
LAB_21b7_0b6a:
    mov     byte ptr [byte_449DA], 0x1
    pop     si
    pop     di
    mov     sp, bp
    pop     bp
    retf
    db 0x90
LAB_21b7_0b76:
    cmp     byte ptr [byte_449DA], 0x0
    jnz     LAB_21b7_0b36
    cmp     byte ptr [state.game_3F6autoLoadEvalFlag], 0x0
    jnz     LAB_21b7_0b36
    cmp     byte ptr [game_replay_mode], 0x1
    jz      LAB_21b7_0b36
    cmp     byte ptr [passed_security], 0x0
    jnz     LAB_21b7_0bb5
    cmp     byte ptr [byte_4393C], 0x0
    jnz     LAB_21b7_0bb5
    mov     ax, word ptr [framespersec]
    shl     ax, 0x1
    shl     ax, 0x1
    cmp     ax, word ptr [state.game_frame]
    jnc     LAB_21b7_0bb5
    sub     ax, ax
    push    ax
    mov     ax, 0x1
    push    ax
    call    far ptr update_crash_state
    add     sp, 0x4
LAB_21b7_0bb5:
    cmp     byte ptr [byte_3B8F2], 0x0
    jnz     LAB_21b7_0bc6
    cmp     byte ptr [byte_3FE00], 0x0
    jnz     LAB_21b7_0bc6
    jmp     near ptr LAB_21b7_0c78
LAB_21b7_0bc6:
    cmp     byte ptr [byte_3B8F2], 0x0
    jz      LAB_21b7_0c2a
    mov     ax, offset mouse_ypos
    push    ax
    mov     ax, offset mouse_xpos
    push    ax
    mov     ax, offset mouse_butstate
    push    ax
    call    far ptr mouse_get_state
    add     sp, 0x6
    mov     di, word ptr [mouse_xpos]
    sub     di, 0xa0
    push    di                                 ; int
    call    far ptr _abs
    add     sp, 0x2
    cmp     ax, 0x12
    jge     LAB_21b7_0bfc
    sub     di, di
    jmp     LAB_21b7_0c09
    db 0x90
LAB_21b7_0bfc:
    or      di, di
    jle     LAB_21b7_0c06
    sub     di, 0x12
    jmp     LAB_21b7_0c09
    db 0x90
LAB_21b7_0c06:
    add     di, 0x12
LAB_21b7_0c09:
    mov     ax, di
    mov     byte ptr [byte_40D6A], al
    test    byte ptr [mouse_butstate], 0x1
    jz      LAB_21b7_0c1a
    mov     si, 0x2
    jmp     LAB_21b7_0c62
LAB_21b7_0c1a:
    test    byte ptr [mouse_butstate], 0x2
    jz      LAB_21b7_0c26
    mov     si, 0x1
    jmp     LAB_21b7_0c62
LAB_21b7_0c26:
    sub     si, si
    jmp     LAB_21b7_0c62
LAB_21b7_0c2a:
    call    far ptr sub_307E3
    mov     byte ptr [byte_40D6A], al
    or      al, al
    jle     LAB_21b7_0c40
    cbw
    mov     bx, ax
    mov     al, byte ptr [bx+byte_3E85C]
    jmp     LAB_21b7_0c55
    db 0x90
LAB_21b7_0c40:
    cmp     byte ptr [byte_40D6A], 0x0
    jge     LAB_21b7_0c58
    mov     al, byte ptr [byte_40D6A]
    cbw
    mov     bx, ax
    neg     bx
    mov     al, byte ptr [bx+byte_3E85C]
    neg     al
LAB_21b7_0c55:
    mov     byte ptr [byte_40D6A], al
LAB_21b7_0c58:
    call    far ptr get_kb_or_joy_flags
    mov     si, ax
    and     si, 0x33
LAB_21b7_0c62:
    mov     di, word ptr [elapsed_time2]
    and     di, 0x3f
    mov     al, byte ptr [byte_40D6A]
    mov     byte ptr [di+byte_44292], al
    mov     byte ptr [di+byte_442EA], 0x1
    jmp     LAB_21b7_0c7f
    db 0x90
LAB_21b7_0c78:
    call    far ptr get_kb_or_joy_flags
    mov     si, ax
LAB_21b7_0c7f:
    mov     ax, 0x1e
    push    ax
    call    far ptr kb_get_key_state
    add     sp, 0x2
    or      ax, ax
    jz      LAB_21b7_0c93
    or      si, 0x10
    nop
LAB_21b7_0c93:
    mov     ax, 0x2c
    push    ax
    call    far ptr kb_get_key_state
    add     sp, 0x2
    or      ax, ax
    jz      LAB_21b7_0ca7
    or      si, 0x20
    nop
LAB_21b7_0ca7:
    mov     ax, 0x5dc
    imul    word ptr [framespersec]
    mov     cx, word ptr [elapsed_time2]
    add     cx, word ptr [elapsed_time1]
    cmp     ax, cx
    ja      LAB_21b7_0ccc
    sub     ax, ax
    push    ax
    mov     ax, 0x4
    push    ax
    call    far ptr update_crash_state
    add     sp, 0x4
    jmp     near ptr LAB_21b7_0b6a
LAB_21b7_0ccc:
    cmp     word ptr [elapsed_time2], 0x2ee0
    jz      LAB_21b7_0cd7
    jmp     near ptr LAB_21b7_0dfc
LAB_21b7_0cd7:
    cmp     word ptr [elapsed_time1], 0x0
    jnz     LAB_21b7_0cf6
    cmp     byte ptr [word_45D3E], 0x0
    jnz     LAB_21b7_0cf6
    mov     byte ptr [word_45D3E], 0x1
    mov     byte ptr [byte_46467], 0x1
    pop     si
    pop     di
    mov     sp, bp
    pop     bp
    retf
    db 0x90
LAB_21b7_0cf6:
    sub     di, di
    jmp     near ptr LAB_21b7_0d99
    db 0x90
LAB_21b7_0cfc:
    mov     ax, 0x460
    cwd
    push    dx
    push    ax
    mov     ax, di
    cwd
    push    dx
    push    ax
    call    far ptr __aFlmul
    add     ax, 0x5a0
    adc     dx, 0x0
    add     ax, word ptr [cvxptr]
    adc     dx, 0x0
    mov     cx, 0xc
    shl     dx, cl
    add     dx, word ptr [cvxptr+2]
    mov     es, dx
    mov     bx, ax
    mov     ax, word ptr [bp+var_6]
    sub     word ptr es:[bx], ax
    mov     ax, 0x460
    cwd
    push    dx
    push    ax
    mov     ax, di
    cwd
    push    dx
    push    ax
    call    far ptr __aFlmul
    add     ax, 0x460
    adc     dx, 0x0
    add     ax, word ptr [cvxptr]
    adc     dx, 0x0
    mov     cx, 0xc
    shl     dx, cl
    add     dx, word ptr [cvxptr+2]
    mov     cx, 0x460
    sub     bx, bx
    push    bx
    push    cx
    mov     cx, ax
    mov     ax, di
    mov     bx, dx
    cwd
    push    dx
    push    ax
    mov     word ptr [bp+var_A], cx
    mov     word ptr [bp+var_8], bx
    call    far ptr __aFlmul
    add     ax, word ptr [cvxptr]
    adc     dx, 0x0
    mov     cx, 0xc
    shl     dx, cl
    add     dx, word ptr [cvxptr+2]
    mov     bx, ax
    mov     es, dx
    mov     ax, word ptr [bp+var_A]
    mov     dx, word ptr [bp+var_8]
    push    si
    push    di
    mov     di, bx
    mov     si, ax
    push    ds
    mov     ds, dx
    mov     cx, 0x230
    rep movsw
    pop     ds
    pop     di
    pop     si
    inc     di
LAB_21b7_0d99:
    mov     ax, 0x1e
    imul    word ptr [framespersec]
    mov     word ptr [bp+var_6], ax
    mov     ax, 0x2ee0
    cwd
    mov     cx, word ptr [bp+var_6]
    idiv    cx
    dec     ax
    cmp     ax, di
    jle     LAB_21b7_0db4
    jmp     near ptr LAB_21b7_0cfc
LAB_21b7_0db4:
    sub     di, di
    jmp     LAB_21b7_0dce
LAB_21b7_0db8:
    mov     bx, word ptr [bp+var_A]
    add     bx, word ptr [td16_rpl_buffer]
    mov     es, word ptr [td16_rpl_buffer+2]
    mov     al, byte ptr es:[bx+di]
    mov     bx, word ptr [td16_rpl_buffer]
    mov     byte ptr es:[bx+di], al
    inc     di
LAB_21b7_0dce:
    mov     ax, 0x1e
    imul    word ptr [framespersec]
    mov     word ptr [bp+var_A], ax
    mov     ax, 0x2ee0
    sub     ax, word ptr [bp+var_A]
    cmp     ax, di
    jg      LAB_21b7_0db8
    mov     ax, 0x1e
    imul    word ptr [framespersec]
    mov     word ptr [bp+var_A], ax
    sub     word ptr [elapsed_time2], ax
    sub     word ptr [gameconfig.game_recordedframes], ax
    add     word ptr [elapsed_time1], ax
    sub     word ptr [state.game_frame], ax
LAB_21b7_0dfc:
    mov     bx, word ptr [elapsed_time2]
    inc     word ptr [elapsed_time2]
    add     bx, word ptr [td16_rpl_buffer]
    mov     es, word ptr [td16_rpl_buffer+2]
    mov     ax, si
    mov     byte ptr es:[bx], al
    inc     word ptr [gameconfig.game_recordedframes]
LAB_21b7_0e15:
    pop     si
    pop     di
    mov     sp, bp
    pop     bp
    retf
replay_unk2_asm_ endp
    db 0x90

; void __cdecl16far sub_2298C(void)
sub_2298C_asm_ proc far
    var_34     = dword ptr -52
    var_30     = word ptr  -48
    var_2E     = word ptr  -46
    var_2C     = word ptr  -44
    var_2A     = word ptr  -42
    var_28     = word ptr  -40
    var_26     = word ptr  -38
    var_opponentstateptr = word ptr  -36
    var_22     = word ptr  -34
    var_20     = word ptr  -32
    var_1E     = word ptr  -30
    var_1C     = word ptr  -28
    var_1A     = word ptr  -26
    var_18     = word ptr  -24
    var_14     = word ptr  -20
    var_10     = word ptr  -16
    var_E      = word ptr  -14
    var_C      = word ptr  -12
    var_A      = byte ptr  -10
    var_8      = word ptr   -8
    var_6      = word ptr   -6
    var_2      = word ptr   -2

    push    bp
    mov     bp, sp
    sub     sp, 0x34
    push    di
    push    si
    mov     word ptr [bp+var_2A], 0x1
    cmp     byte ptr [gameconfig.game_opponenttype], 0x0
    jz      LAB_21b7_0e35
    mov     word ptr [bp+var_2A], 0x2
LAB_21b7_0e35:
    sub     si, si
    jmp     near ptr LAB_21b7_10e3
LAB_21b7_0e3a:
    mov     word ptr [bp+var_opponentstateptr], offset state.opponentstate.car_posWorld1.lx
LAB_21b7_0e3f:
    mov     bx, word ptr [bp+var_opponentstateptr]
    mov     ax, word ptr [bx+0x4]
    mov     dx, word ptr [bx+0x6]
    mov     cl, 0x6
LAB_21b7_0e4a:
    sar     dx, 0x1
    rcr     ax, 0x1
    dec     cl
    jnz     LAB_21b7_0e4a
    mov     word ptr [bp+var_1A], ax
    mov     bx, word ptr [bp+var_opponentstateptr]
    mov     ax, word ptr [bx]
    mov     dx, word ptr [bx+0x2]
    mov     cl, 0x6
LAB_21b7_0e5f:
    sar     dx, 0x1
    rcr     ax, 0x1
    dec     cl
    jnz     LAB_21b7_0e5f
    mov     word ptr [bp+var_1C], ax
    mov     bx, word ptr [bp+var_opponentstateptr]
    mov     ax, word ptr [bx+0x8]
    mov     dx, word ptr [bx+0xa]
    mov     cl, 0x6
LAB_21b7_0e75:
    sar     dx, 0x1
    rcr     ax, 0x1
    dec     cl
    jnz     LAB_21b7_0e75
    mov     word ptr [bp+var_18], ax
    mov     bx, word ptr [bp+var_opponentstateptr]
    push    si
    push    di
    lea     di, [bp+var_6]
    lea     si, [bx+0xa4]
    push    ss
    pop     es
    movsw
    movsw
    movsw
    pop     di
    pop     si
    mov     bx, word ptr [bp+var_opponentstateptr]
    mov     ax, word ptr [bx+0x48]
    mov     word ptr [bp+var_E], ax
    or      si, si
    jnz     LAB_21b7_0eae
    cmp     byte ptr [state.field_45B], 0x0
    jnz     LAB_21b7_0ed0
    cmp     byte ptr [state.field_45C], 0x0
    jnz     LAB_21b7_0ed0
LAB_21b7_0eae:
    cmp     word ptr [bx+0xb6], 0x0
    jnz     LAB_21b7_0ed0
    cmp     byte ptr [bx+0xc9], 0x0
    jnz     LAB_21b7_0ed0
    cmp     word ptr [bx+0x4a], -0x1
    jz      LAB_21b7_0ed0
    cmp     word ptr [bp+var_E], 0x80
    jle     LAB_21b7_0edd
    cmp     word ptr [bp+var_E], 0x380
    jge     LAB_21b7_0edd
LAB_21b7_0ed0:
    push    si
    push    di
    lea     di, [bp+var_6]
    lea     si, [bp+var_1C]
    movsw
    movsw
    movsw
    pop     di
    pop     si
LAB_21b7_0edd:
    mov     word ptr [bp+var_22], 0x1c2
    mov     ax, word ptr [bp+var_1A]
    add     ax, 0x10e
    mov     word ptr [bp+var_14], ax
    mov     bx, si
    mov     ax, bx
    shl     bx, 0x1
    add     bx, ax
    shl     bx, 0x1
    mov     ax, word ptr [bx+0x8e46]
    sub     ax, word ptr [bp+var_14]
    mov     word ptr [bp+var_C], ax
    or      ax, ax
    jz      LAB_21b7_0f26
    mov     di, ax
    cmp     di, 0x1e
    jle     LAB_21b7_0f10
    mov     di, 0x1e
    jmp     LAB_21b7_0f18
    db 0x90
LAB_21b7_0f10:
    cmp     di, -0x1e
    jge     LAB_21b7_0f18
    mov     di, 0xffe2
LAB_21b7_0f18:
    mov     bx, si
    mov     ax, bx
    shl     bx, 0x1
    add     bx, ax
    shl     bx, 0x1
    sub     word ptr [bx+state.game_vec1.vy], di
LAB_21b7_0f26:
    mov     ax, si
    mov     cx, ax
    shl     ax, 0x1
    add     ax, cx
    shl     ax, 0x1
    mov     word ptr [bp+var_2E], ax
    mov     ax, word ptr [bp+var_2]
    mov     bx, word ptr [bp+var_2E]
    sub     ax, word ptr [bx+state.game_vec1.vz]
    push    ax
    mov     ax, word ptr [bp+var_6]
    sub     ax, word ptr [bx+state.game_vec1.vx]
    push    ax
    call    far ptr polarAngle
    add     sp, 0x4
    mov     word ptr [bp+var_10], ax
    mov     ax, si
    mov     cx, ax
    shl     ax, 0x1
    add     ax, cx
    shl     ax, 0x1
    mov     word ptr [bp+var_30], ax
    mov     ax, word ptr [bp+var_18]
    mov     bx, word ptr [bp+var_30]
    sub     ax, word ptr [bx+state.game_vec1.vz]
    push    ax
    mov     ax, word ptr [bp+var_1C]
    sub     ax, word ptr [bx+state.game_vec1.vx]
    push    ax
    call    far ptr polarRadius2D
    add     sp, 0x4
    mov     di, ax
    cmp     word ptr [bp+var_22], di
    jge     LAB_21b7_0fe3
    sub     di, word ptr [bp+var_22]
    cmp     word ptr [framespersec], 0x14
    jnz     LAB_21b7_0f94
    cmp     di, 0x78
    jle     LAB_21b7_0f9d
    mov     di, 0x78
    jmp     LAB_21b7_0f9d
LAB_21b7_0f94:
    cmp     di, 0xf0
    jle     LAB_21b7_0f9d
    mov     di, 0xf0
LAB_21b7_0f9d:
    push    word ptr [bp+var_10]
    call    far ptr sin_fast
    add     sp, 0x2
    push    ax
    push    di
    call    far ptr multiply_and_scale
    add     sp, 0x4
    mov     bx, si
    mov     cx, bx
    shl     bx, 0x1
    add     bx, cx
    shl     bx, 0x1
    add     word ptr [bx+state.game_vec1.vx], ax
    push    word ptr [bp+var_10]
    call    far ptr cos_fast
    add     sp, 0x2
    push    ax
    push    di
    call    far ptr multiply_and_scale
    add     sp, 0x4
    mov     bx, si
    mov     cx, bx
    shl     bx, 0x1
    add     bx, cx
    shl     bx, 0x1
    add     word ptr [bx+state.game_vec1.vz], ax
LAB_21b7_0fe3:
    mov     ax, word ptr [state.game_frame]
    sub     dx, dx
    mov     cx, word ptr [framespersec]
    sar     cx, 0x1
    div     cx
    or      dx, dx
    jz      LAB_21b7_0ff7
    jmp     near ptr LAB_21b7_10e2
LAB_21b7_0ff7:
    mov     word ptr [bp+var_2C], 0x2710
    mov     byte ptr [bp+var_A], 0x0
    jmp     LAB_21b7_1073
    db 0x90
    db 0x90
LAB_21b7_1004:
    mov     ax, word ptr [bp+var_20]
    mov     dx, word ptr [bp+var_1E]
LAB_21b7_100a:
    mov     cx, ax
    mov     ax, word ptr [bp+var_2C]
    mov     bx, dx
    cwd
    cmp     bx, dx
    jg      LAB_21b7_1070
    jl      LAB_21b7_101c
    cmp     cx, ax
    jnc     LAB_21b7_1070
LAB_21b7_101c:
    cmp     word ptr [bp+var_26], 0x0
    jge     LAB_21b7_1032
    mov     ax, word ptr [bp+var_28]
    mov     dx, word ptr [bp+var_26]
    neg     ax
    adc     dx, 0x0
    neg     dx
    jmp     LAB_21b7_1038
    db 0x90
LAB_21b7_1032:
    mov     ax, word ptr [bp+var_28]
    mov     dx, word ptr [bp+var_26]
LAB_21b7_1038:
    mov     cx, ax
    mov     ax, word ptr [bp+var_2C]
    mov     bx, dx
    cwd
    cmp     bx, dx
    jg      LAB_21b7_1070
    jl      LAB_21b7_104a
    cmp     cx, ax
    jnc     LAB_21b7_1070
LAB_21b7_104a:
    push    word ptr [bp+var_28]
    push    word ptr [bp+var_20]
    call    far ptr polarRadius2D
    add     sp, 0x4
    mov     word ptr [bp+var_8], ax
    mov     ax, word ptr [bp+var_2C]
    cmp     word ptr [bp+var_8], ax
    jge     LAB_21b7_1070
    mov     al, byte ptr [bp+var_A]
    mov     byte ptr [si+state.field_3F7], al
    mov     ax, word ptr [bp+var_8]
    mov     word ptr [bp+var_2C], ax
LAB_21b7_1070:
    inc     byte ptr [bp+var_A]
LAB_21b7_1073:
    mov     al, byte ptr [byte_4616E]
    cmp     byte ptr [bp+var_A], al
    jge     LAB_21b7_10e2
    mov     al, byte ptr [bp+var_A]
    cbw
    mov     cx, ax
    shl     ax, 0x1
    add     ax, cx
    shl     ax, 0x1
    add     ax, word ptr [trackdata9]
    mov     dx, word ptr [trackdata9+2]
    mov     word ptr [bp+var_34], ax
    mov     word ptr [bp+var_34+2], dx
    mov     ax, word ptr [bp+var_1C]
    cwd
    les     bx, [bp+var_34]
    mov     cx, ax
    mov     ax, word ptr es:[bx]
    mov     bx, dx
    cwd
    sub     ax, cx
    sbb     dx, bx
    mov     word ptr [bp+var_20], ax
    mov     word ptr [bp+var_1E], dx
    mov     ax, word ptr [bp+var_18]
    cwd
    mov     bx, word ptr [bp+var_34]
    mov     cx, ax
    mov     ax, word ptr es:[bx+0x4]
    mov     bx, dx
    cwd
    sub     ax, cx
    sbb     dx, bx
    mov     word ptr [bp+var_28], ax
    mov     word ptr [bp+var_26], dx
    cmp     word ptr [bp+var_1E], 0x0
    jl      LAB_21b7_10d1
    jmp     near ptr LAB_21b7_1004
LAB_21b7_10d1:
    mov     ax, word ptr [bp+var_20]
    mov     dx, word ptr [bp+var_1E]
    neg     ax
    adc     dx, 0x0
    neg     dx
    jmp     near ptr LAB_21b7_100a
    db 0x90
LAB_21b7_10e2:
    inc     si
LAB_21b7_10e3:
    cmp     word ptr [bp+var_2A], si
    jle     LAB_21b7_111c
    mov     ax, si
    mov     cx, ax
    shl     ax, 0x1
    add     ax, cx
    shl     ax, 0x1
    mov     word ptr [bp+var_2E], ax
    mov     bx, ax
    lea     ax, [bx+state.game_vec1.vx]
    mov     bx, word ptr [bp+var_2E]
    push    si
    push    di
    lea     di, [bx+state.game_vec3.vx]
    mov     si, ax
    push    ds
    pop     es
    movsw
    movsw
    movsw
    pop     di
    pop     si
    or      si, si
    jz      LAB_21b7_1114
    jmp     near ptr LAB_21b7_0e3a
LAB_21b7_1114:
    mov     word ptr [bp+var_opponentstateptr], offset state.playerstate.car_posWorld1.lx
    jmp     near ptr LAB_21b7_0e3f
LAB_21b7_111c:
    pop     si
    pop     di
    mov     sp, bp
    pop     bp
    retf
sub_2298C_asm_ endp

; int __cdecl16far file_load_replay(char * dir, char * filename)
file_load_replay_asm_ proc far
    dir        = word ptr    6
    filename   = word ptr    8

    push    bp
    mov     bp, sp
    push    di
    push    si
    mov     ax, offset g_path_buf
    push    ax                                 ; char *
    mov     ax, offset a_rpl
    push    ax                                 ; int
    push    word ptr [bp+filename]
    push    word ptr [bp+dir]                  ; char *
    call    far ptr file_build_path
    add     sp, 0x8
    mov     byte ptr [g_is_busy], 0x1
    push    word ptr [td13_rpl_header+2]
    push    word ptr [td13_rpl_header]
    mov     ax, offset g_path_buf
    push    ax
    call    far ptr file_read_fatal
    add     sp, 0x6
    mov     ax, word ptr [td13_rpl_header]
    mov     dx, word ptr [td13_rpl_header+2]
    mov     di, offset gameconfig
    mov     si, ax
    push    ds
    pop     es
    push    ds
    mov     ds, dx
    mov     cx, 0xd                            ; copies 13 words from the rpl to gameconfig
    rep movsw
    pop     ds
    mov     byte ptr [g_is_busy], 0x0
    sub     ax, ax
    pop     si
    pop     di
    pop     bp
    retf
file_load_replay_asm_ endp

; int __cdecl16far file_write_replay(char * filename)
file_write_replay_asm_ proc far
    var_6      = word ptr   -6
    var_4      = word ptr   -4
    filename   = word ptr    6

    push    bp
    mov     bp, sp
    sub     sp, 0x6
    push    di
    push    si
    les     bx, [td13_rpl_header]
    push    si
    mov     di, bx
    mov     si, offset gameconfig
    mov     cx, 0xd
    rep movsw
    pop     si
    mov     ax, word ptr [gameconfig.game_recordedframes]
    add     ax, 0x724                          ; offset of .rpl kb. event block
    cwd
    mov     word ptr [bp+var_6], ax
    mov     word ptr [bp+var_4], dx
    mov     byte ptr [g_is_busy], 0x1
    push    dx
    push    ax
    push    es
    push    bx
    push    word ptr [bp+filename]
    call    far ptr file_write_fatal
    add     sp, 0xa
    mov     byte ptr [g_is_busy], 0x0
    cbw
    pop     si
    pop     di
    mov     sp, bp
    pop     bp
    retf
file_write_replay_asm_ endp
    db 0x90

; void __cdecl16far setup_car_shapes(int param_1)
setup_car_shapes_asm_ proc far
    var_20     = word ptr  -32
    var_1E     = word ptr  -30
    var_1C     = byte ptr  -28
    var_1A     = byte ptr  -26
    var_18     = byte ptr  -24
    var_16     = byte ptr  -22
    var_14     = byte ptr  -20
    var_E      = word ptr  -14
    var_C      = dword ptr -12
    var_8      = word ptr   -8
    var_6      = byte ptr   -6
    var_4      = word ptr   -4
    var_2      = byte ptr   -2
    param_1    = word ptr    6

    push    bp
    mov     bp, sp
    sub     sp, 0x20
    push    di
    push    si
    mov     ax, word ptr [bp+param_1]
    or      ax, ax
    jz      LAB_21b7_11ec
    cmp     ax, 0x1
    jnz     LAB_21b7_11d5
    jmp     near ptr LAB_21b7_1406
LAB_21b7_11d5:
    cmp     ax, 0x2
    jnz     LAB_21b7_11dd
    jmp     near ptr LAB_21b7_14c0
LAB_21b7_11dd:
    cmp     ax, 0x3
    jnz     LAB_21b7_11e5
    jmp     near ptr LAB_21b7_1b3c
LAB_21b7_11e5:
    pop     si
    pop     di
    mov     sp, bp
    pop     bp
    retf
    db 0x90
LAB_21b7_11ec:
    mov     al, byte ptr [gameconfig]
    mov     byte ptr [(aStdaxxxx+4)], al
    mov     al, byte ptr [gameconfig.(game_playercarid+1)]
    mov     byte ptr [(aStdaxxxx+5)], al
    mov     al, byte ptr [gameconfig.(game_playercarid+2)]
    mov     byte ptr [(aStdaxxxx+6)], al
    mov     al, byte ptr [gameconfig.(game_playercarid+3)]
    mov     byte ptr [(aStdaxxxx+7)], al
    mov     al, byte ptr [gameconfig]
    mov     byte ptr [(aStdbxxxx+4)], al
    mov     al, byte ptr [gameconfig.(game_playercarid+1)]
    mov     byte ptr [(aStdbxxxx+5)], al
    mov     al, byte ptr [gameconfig.(game_playercarid+2)]
    mov     byte ptr [(aStdbxxxx+6)], al
    mov     al, byte ptr [gameconfig.(game_playercarid+3)]
    mov     byte ptr [(aStdbxxxx+7)], al
    mov     ax, offset aStdaxxxx
    push    ax                                 ; char *
    mov     ax, 0x3
    push    ax                                 ; int
    call    far ptr file_load_resource
    add     sp, 0x4
    mov     word ptr [stdaresptr], ax
    mov     word ptr [stdaresptr+2], dx
    mov     ax, offset aStdbxxxx
    push    ax                                 ; char *
    mov     ax, 0x2
    push    ax                                 ; int
    call    far ptr file_load_resource
    add     sp, 0x4
    mov     word ptr [stdbresptr], ax
    mov     word ptr [stdbresptr+2], dx
    mov     ax, offset whlshapes
    push    ax
    mov     ax, offset aWhl1whl2whl3ins2gboxins1i
    push    ax
    push    word ptr [stdaresptr+2]
    push    word ptr [stdaresptr]
    call    far ptr locate_many_resources
    add     sp, 0x8
    mov     ax, offset gnobshapes
    push    ax
    mov     ax, offset aGnobgnabdotDotadot1dot2
    push    ax
    push    word ptr [stdbresptr+2]
    push    word ptr [stdbresptr]
    call    far ptr locate_many_resources
    add     sp, 0x8
    cmp     word ptr [simd_player.spdcenter.y2], 0x0
    jnz     LAB_21b7_1299
    mov     ax, offset digshapes
    push    ax
    mov     ax, offset aDig0dig1dig2dig3dig4dig5d
    push    ax
    push    word ptr [stdbresptr+2]
    push    word ptr [stdbresptr]
    call    far ptr locate_many_resources
    add     sp, 0x8
LAB_21b7_1299:
    mov     ax, 0xf
    push    ax
    les     bx, [(whlshapes+3*4)]
    push    word ptr es:[bx+0x2]
    mov     ax, word ptr es:[bx]
    imul    word ptr [video_flag1_is1]
    push    ax
    call    far ptr sprite_make_wnd
    add     sp, 0x6
    mov     word ptr [whlsprite1], ax
    mov     word ptr [whlsprite1+2], dx
    mov     ax, 0xf
    push    ax
    les     bx, [(whlshapes+4*4)]
    push    word ptr es:[bx+0x2]
    mov     ax, word ptr es:[bx]
    imul    word ptr [video_flag1_is1]
    push    ax
    call    far ptr sprite_make_wnd
    add     sp, 0x6
    mov     word ptr [whlsprite2], ax
    mov     word ptr [whlsprite2+2], dx
    mov     ax, 0xf
    push    ax
    les     bx, [(whlshapes+4*4)]
    push    word ptr es:[bx+0x2]
    mov     ax, word ptr es:[bx]
    imul    word ptr [video_flag1_is1]
    push    ax
    call    far ptr sprite_make_wnd
    add     sp, 0x6
    mov     word ptr [whlsprite3], ax
    mov     word ptr [whlsprite3+2], dx
    mov     ax, offset aDash
    push    ax
    push    word ptr [stdaresptr+2]
    push    word ptr [stdaresptr]
    call    far ptr locate_shape_fatal
    add     sp, 0x6
    mov     word ptr [bp+var_C], ax
    mov     word ptr [bp+var_C+2], dx
    push    word ptr [whlsprite3+2]
    push    word ptr [whlsprite3]
    call    far ptr sprite_set_1_from_argptr
    add     sp, 0x4
    les     bx, [bp+var_C]
    mov     ax, word ptr es:[bx+0xa]
    les     bx, [(whlshapes+4*4)]
    sub     ax, word ptr es:[bx+0xa]
    push    ax
    les     bx, [bp+var_C]
    mov     ax, word ptr es:[bx+0x8]
    les     bx, [(whlshapes+4*4)]
    sub     ax, word ptr es:[bx+0x8]
    push    ax
    push    word ptr [bp+var_C+2]
    push    word ptr [bp+var_C]
    call    far ptr shape2d_op_unk2
    add     sp, 0x8
    call    far ptr sprite_copy_2_to_1
    les     bx, [bp+var_C]
    mov     ax, word ptr es:[bx+0xa]
    mov     word ptr [dashbmp_y], ax
    mov     ax, offset aRoof
    push    ax
    push    word ptr [stdaresptr+2]
    push    word ptr [stdaresptr]
    call    far ptr locate_shape_nofatal
    add     sp, 0x6
    or      dx, ax
    jz      LAB_21b7_13a2
    mov     ax, offset aRoof_0
    push    ax
    push    word ptr [stdaresptr+2]
    push    word ptr [stdaresptr]
    call    far ptr locate_shape_fatal
    add     sp, 0x6
    mov     bx, ax
    mov     es, dx
    mov     ax, word ptr es:[bx+0x2]
    mov     word ptr [roofbmpheight], ax
    jmp     LAB_21b7_13a8
LAB_21b7_13a2:
    mov     word ptr [roofbmpheight], 0x0
LAB_21b7_13a8:
    mov     ax, offset aDast
    push    ax
    push    word ptr [stdaresptr+2]
    push    word ptr [stdaresptr]
    call    far ptr locate_shape_nofatal
    add     sp, 0x6
    mov     word ptr [bp+var_C], ax
    mov     word ptr [bp+var_C+2], dx
    or      ax, dx
    jz      LAB_21b7_13fa
    les     bx, [bp+var_C]
    mov     ax, word ptr es:[bx+0xa]
    mov     word ptr [dastbmp_y], ax
    mov     ax, bx
    mov     word ptr [dastbmp_y2], ax
    mov     word ptr [dastseg], dx
    mov     ax, offset aDasm
    push    ax
    push    word ptr [stdaresptr+2]
    push    word ptr [stdaresptr]
    call    far ptr locate_shape_fatal
    add     sp, 0x6
    mov     word ptr [dasmshapeptr], ax
    mov     word ptr [dasmshapeptr+2], dx
    pop     si
    pop     di
    mov     sp, bp
    pop     bp
    retf
LAB_21b7_13fa:
    mov     word ptr [dastbmp_y], 0x0
    pop     si
    pop     di
    mov     sp, bp
    pop     bp
    retf
LAB_21b7_1406:
    call    far ptr mouse_draw_opaque_check
    mov     ax, offset aRoof_1
    push    ax
    push    word ptr [stdaresptr+2]
    push    word ptr [stdaresptr]
    call    far ptr locate_shape_nofatal
    add     sp, 0x6
    or      dx, ax
    jz      LAB_21b7_1441
    mov     ax, offset aRoof_2
    push    ax
    push    word ptr [stdaresptr+2]
    push    word ptr [stdaresptr]
    call    far ptr locate_shape_fatal
    add     sp, 0x6
    push    dx
    push    ax
    call    far ptr shape2d_op_unk
    add     sp, 0x4
LAB_21b7_1441:
    mov     ax, offset aDash_0
    push    ax
    push    word ptr [stdaresptr+2]
    push    word ptr [stdaresptr]
    call    far ptr locate_shape_fatal
    add     sp, 0x6
    push    dx
    push    ax
    call    far ptr shape2d_op_unk3
    add     sp, 0x4
    push    word ptr [(whlshapes+1*4)+2]
    push    word ptr [(whlshapes+1*4)]
    call    far ptr shape2d_op_unk3
    add     sp, 0x4
    call    far ptr mouse_draw_transparent_check
    sub     si, si
    mov     al, byte ptr [byte_4432A]
    cbw
    mov     word ptr [bp+var_1E], ax
    mov     bx, ax
    sub     al, al
    mov     byte ptr [bx+byte_449D8], al
    mov     bx, word ptr [bp+var_1E]
    mov     byte ptr [bx+byte_40DFA], al
    mov     ax, word ptr [bp+var_1E]
    shl     ax, 0x1
    mov     word ptr [bp+var_20], ax
    mov     bx, ax
    mov     word ptr [bx+word_40DF6], si
    mov     bx, word ptr [bp+var_1E]
    sub     al, al
    mov     byte ptr [bx+byte_40DF0], al
    dec     si
    mov     bx, word ptr [bp+var_20]
    mov     word ptr [bx+word_40E00], si
    mov     bx, word ptr [bp+var_20]
    mov     word ptr [bx+word_40D78], si
    mov     bx, word ptr [bp+var_20]
    mov     word ptr [bx+word_40D6C], si
    pop     si
    pop     di
    mov     sp, bp
    pop     bp
    retf
    db 0x90
LAB_21b7_14c0:
    mov     al, byte ptr [state.playerstate.car_fpsmul2]
    cbw
    mov     cx, ax
    mov     al, byte ptr [state.playerstate.car_changing_gear]
    cbw
    or      ax, cx
    jnz     LAB_21b7_152a
    mov     al, byte ptr [byte_4432A]
    cbw
    mov     bx, ax
    cmp     byte ptr [bx+byte_40DFA], 0x0
    jz      LAB_21b7_152a
    cmp     byte ptr [video_flag5_is0], 0x0
    jnz     LAB_21b7_14e7
    call    far ptr mouse_draw_opaque_check
LAB_21b7_14e7:
    push    word ptr [height_above_replaybar]
    sub     ax, ax
    push    ax
    mov     ax, 0x140
    push    ax
    sub     ax, ax
    push    ax
    call    far ptr sprite_set_1_size
    add     sp, 0x8
    les     bx, [(whlshapes+4*4)]
    push    word ptr es:[bx+0xa]
    push    word ptr es:[bx+0x8]
    les     bx, [whlsprite3]
    push    word ptr es:[bx+0x2]
    push    word ptr es:[bx]
    call    far ptr sprite_putimage_and_alt
    add     sp, 0x8
    mov     al, byte ptr [byte_4432A]
    cbw
    mov     bx, ax
    mov     byte ptr [bx+byte_40DFA], 0x0
    jmp     near ptr LAB_21b7_162d
LAB_21b7_152a:
    mov     al, byte ptr [byte_4432A]
    cbw
    mov     word ptr [bp+var_20], ax
    mov     bx, ax
    mov     al, byte ptr [state.playerstate.car_changing_gear]
    cmp     byte ptr [bx+byte_40DFA], al
    jnz     LAB_21b7_156e
    mov     ax, bx
    shl     ax, 0x1
    mov     word ptr [bp+var_1E], ax
    mov     bx, ax
    mov     ax, word ptr [state.playerstate.car_knob_x]
    cmp     word ptr [bx+word_40D70], ax
    jnz     LAB_21b7_156e
    mov     ax, word ptr [state.playerstate.car_knob_y]
    cmp     word ptr [bx+word_40D74], ax
    jnz     LAB_21b7_156e
    cmp     byte ptr [state.playerstate.car_fpsmul2], 0x0
    jnz     LAB_21b7_1561
    jmp     near ptr LAB_21b7_162d
LAB_21b7_1561:
    mov     bx, word ptr [bp+var_20]
    cmp     byte ptr [bx+byte_40DFA], 0x0
    jz      LAB_21b7_156e
    jmp     near ptr LAB_21b7_162d
LAB_21b7_156e:
    push    word ptr [whlsprite2+2]
    push    word ptr [whlsprite2]
    call    far ptr sprite_set_1_from_argptr
    add     sp, 0x4
    mov     al, byte ptr [byte_4432A]
    cbw
    mov     bx, ax
    mov     byte ptr [bx+byte_40DFA], 0x1
    sub     ax, ax
    push    ax
    push    ax
    push    word ptr [(whlshapes+4*4)+2]
    push    word ptr [(whlshapes+4*4)]
    call    far ptr shape2d_op_unk2
    add     sp, 0x8
    mov     si, word ptr [state.playerstate.car_knob_x]
    mov     di, word ptr [state.playerstate.car_knob_y]
    mov     al, byte ptr [byte_4432A]
    cbw
    shl     ax, 0x1
    mov     word ptr [bp+var_20], ax
    mov     bx, ax
    mov     word ptr [bx+word_40D70], si
    mov     bx, word ptr [bp+var_20]
    mov     word ptr [bx+word_40D74], di
    push    di
    push    si
    push    word ptr [(gnobshapes+1*4)+2]
    push    word ptr [(gnobshapes+1*4)]
    call    far ptr sprite_putimage_and_alt2
    add     sp, 0x8
    push    di
    push    si
    push    word ptr [gnobshapes+2]
    push    word ptr [gnobshapes]
    call    far ptr sprite_putimage_or_alt
    add     sp, 0x8
    cmp     byte ptr [video_flag5_is0], 0x0
    jz      LAB_21b7_15ee
    call    far ptr setup_mcgawnd2
    jmp     LAB_21b7_15f8
    db 0x90
LAB_21b7_15ee:
    call    far ptr sprite_copy_2_to_1_2
    call    far ptr mouse_draw_opaque_check
LAB_21b7_15f8:
    push    word ptr [height_above_replaybar]
    sub     ax, ax
    push    ax
    mov     ax, 0x140
    push    ax
    sub     ax, ax
    push    ax
    call    far ptr sprite_set_1_size
    add     sp, 0x8
    les     bx, [(whlshapes+4*4)]
    push    word ptr es:[bx+0xa]
    push    word ptr es:[bx+0x8]
    les     bx, [whlsprite2]
    push    word ptr es:[bx+0x2]
    push    word ptr es:[bx]
    call    far ptr sprite_putimage_and_alt
    add     sp, 0x8
LAB_21b7_162d:
    mov     byte ptr [bp+var_1A], 0x0
    mov     ax, word ptr [state.playerstate.car_steeringAngle]
    cwd
    xor     ax, dx
    sub     ax, dx
    mov     cx, 0x3
    sar     ax, cl
    xor     ax, dx
    sub     ax, dx
    mov     word ptr [bp+var_4], ax
    mov     byte ptr [bp+var_2], 0x1
    cmp     ax, 0xfff6
    jge     LAB_21b7_1654
    mov     byte ptr [bp+var_2], 0x0
    jmp     LAB_21b7_165e
LAB_21b7_1654:
    cmp     word ptr [bp+var_4], 0xa
    jle     LAB_21b7_165e
    mov     byte ptr [bp+var_2], 0x2
LAB_21b7_165e:
    mov     al, byte ptr [byte_4432A]
    cbw
    mov     bx, ax
    mov     al, byte ptr [bp+var_2]
    cmp     byte ptr [bx+byte_40DF0], al
    jnz     LAB_21b7_1677
    cmp     byte ptr [byte_454A4], 0x0
    jnz     LAB_21b7_1677
    jmp     near ptr LAB_21b7_1716
LAB_21b7_1677:
    cmp     byte ptr [video_flag5_is0], 0x0
    jnz     LAB_21b7_1683
    call    far ptr mouse_draw_opaque_check
LAB_21b7_1683:
    mov     al, byte ptr [byte_4432A]
    cbw
    shl     ax, 0x1
    mov     word ptr [bp+var_20], ax
    mov     bx, ax
    cmp     word ptr [bx+word_40DF6], 0x0
    jz      LAB_21b7_16c9
    push    word ptr [bx+word_40DF6]
    push    word ptr [bx+word_40DF2]
    mov     al, byte ptr [byte_44346]
    cbw
    mov     bx, ax
    shl     bx, 0x1
    shl     bx, 0x1
    push    word ptr [bx+(gnobshapes+4*4)+2]
    push    word ptr [bx+(gnobshapes+4*4)]
    call    far ptr sprite_putimage_and_alt
    add     sp, 0x8
    mov     al, byte ptr [byte_4432A]
    cbw
    mov     bx, ax
    shl     bx, 0x1
    mov     word ptr [bx+word_40DF6], 0x0
    mov     byte ptr [bp+var_1A], 0x1
LAB_21b7_16c9:
    mov     al, byte ptr [bp+var_2]
    cbw
    or      ax, ax
    jz      LAB_21b7_16de
    cmp     ax, 0x1
    jz      LAB_21b7_1702
    cmp     ax, 0x2
    jz      LAB_21b7_170c
    jmp     LAB_21b7_16ee
    db 0x90
LAB_21b7_16de:
    push    word ptr [whlshapes+2]
    push    word ptr [whlshapes]
LAB_21b7_16e6:
    call    far ptr shape2d_op_unk3
    add     sp, 0x4
LAB_21b7_16ee:
    mov     al, byte ptr [byte_4432A]
    cbw
    mov     bx, ax
    mov     al, byte ptr [bp+var_2]
    mov     byte ptr [bx+byte_40DF0], al
    mov     byte ptr [bp+var_18], 0x1
    jmp     LAB_21b7_171a
    db 0x90
LAB_21b7_1702:
    push    word ptr [(whlshapes+1*4)+2]
    push    word ptr [(whlshapes+1*4)]
    jmp     LAB_21b7_16e6
LAB_21b7_170c:
    push    word ptr [(whlshapes+2*4)+2]
    push    word ptr [(whlshapes+2*4)]
    jmp     LAB_21b7_16e6
LAB_21b7_1716:
    mov     byte ptr [bp+var_18], 0x0
LAB_21b7_171a:
    mov     ax, word ptr [simd_player.spdcenter.y2]
    cmp     ax, 0xffff
    jz      LAB_21b7_1746
    or      ax, ax
    jnz     LAB_21b7_1729
    jmp     near ptr LAB_21b7_1832
LAB_21b7_1729:
    mov     byte ptr [bp+var_6], 0x0
    mov     ax, word ptr [state.playerstate.car_speed]
    sub     dx, dx
    mov     cx, 0x280
    div     cx
    mov     si, ax
    cmp     word ptr [simd_player.spdnumpoints], si
    jg      LAB_21b7_174c
    mov     si, word ptr [simd_player.spdnumpoints]
    dec     si
    jmp     LAB_21b7_174c
LAB_21b7_1746:
    sub     si, si
    mov     byte ptr [bp+var_6], 0x2
LAB_21b7_174c:
    mov     ax, word ptr [state.playerstate.car_currpm]
    mov     cl, 0x7
    shr     ax, cl
    mov     di, ax
    cmp     word ptr [simd_player.revnumpoints], di
    jg      LAB_21b7_1760
    mov     di, word ptr [simd_player.revnumpoints]
    dec     di
LAB_21b7_1760:
    cmp     byte ptr [bp+var_18], 0x0
    jnz     LAB_21b7_1787
    cmp     byte ptr [byte_454A4], 0x0
    jnz     LAB_21b7_1787
    mov     al, byte ptr [byte_4432A]
    cbw
    shl     ax, 0x1
    mov     word ptr [bp+var_20], ax
    mov     bx, ax
    cmp     word ptr [bx+word_40D78], si
    jnz     LAB_21b7_1787
    cmp     word ptr [bx+word_40D6C], di
    jnz     LAB_21b7_1787
    jmp     near ptr LAB_21b7_19d0
LAB_21b7_1787:
    cmp     byte ptr [video_flag5_is0], 0x0
    jnz     LAB_21b7_1793
    call    far ptr mouse_draw_opaque_check
LAB_21b7_1793:
    mov     al, byte ptr [byte_4432A]
    cbw
    shl     ax, 0x1
    mov     word ptr [bp+var_20], ax
    mov     bx, ax
    cmp     word ptr [bx+word_40DF6], 0x0
    jz      LAB_21b7_17d9
    push    word ptr [bx+word_40DF6]
    push    word ptr [bx+word_40DF2]
    mov     al, byte ptr [byte_44346]
    cbw
    mov     bx, ax
    shl     bx, 0x1
    shl     bx, 0x1
    push    word ptr [bx+(gnobshapes+4*4)+2]
    push    word ptr [bx+(gnobshapes+4*4)]
    call    far ptr sprite_putimage_and_alt
    add     sp, 0x8
    mov     al, byte ptr [byte_4432A]
    cbw
    mov     bx, ax
    shl     bx, 0x1
    mov     word ptr [bx+word_40DF6], 0x0
    mov     byte ptr [bp+var_1A], 0x1
LAB_21b7_17d9:
    push    word ptr [whlsprite1+2]
    push    word ptr [whlsprite1]
    call    far ptr sprite_set_1_from_argptr
    add     sp, 0x4
    sub     ax, ax
    push    ax
    push    ax
    push    word ptr [(whlshapes+3*4)+2]
    push    word ptr [(whlshapes+3*4)]
    call    far ptr shape2d_op_unk5
    add     sp, 0x8
    mov     al, byte ptr [byte_4432A]
    cbw
    shl     ax, 0x1
    mov     word ptr [bp+var_20], ax
    mov     bx, ax
    mov     word ptr [bx+word_40D78], si
    mov     bx, word ptr [bp+var_20]
    mov     word ptr [bx+word_40D6C], di
    cmp     byte ptr [bp+var_6], 0x1
    jz      LAB_21b7_181c
    jmp     near ptr LAB_21b7_18e6
LAB_21b7_181c:
    mov     word ptr [bp+var_8], 0x0
    cmp     si, 0xc8
    jl      LAB_21b7_1842
    mov     word ptr [bp+var_8], 0x2
    sub     si, 0xc8
    jmp     LAB_21b7_184f
LAB_21b7_1832:
    mov     byte ptr [bp+var_6], 0x1
    mov     ax, word ptr [state.playerstate.car_speed]
    mov     cl, 0x8
    shr     ax, cl
    mov     si, ax
    jmp     near ptr LAB_21b7_174c
LAB_21b7_1842:
    cmp     si, 0x64
    jl      LAB_21b7_184f
    mov     word ptr [bp+var_8], 0x1
    sub     si, 0x64
LAB_21b7_184f:
    cmp     word ptr [bp+var_8], 0x0
    jz      LAB_21b7_187a
    mov     al, byte ptr [simd_player.(spdpoints+1)]
    sub     ah, ah
    push    ax
    mov     al, byte ptr [simd_player.spdpoints]
    push    ax
    mov     bx, word ptr [bp+var_8]
    shl     bx, 0x1
    shl     bx, 0x1
    push    word ptr [bx+digshapes+2]
    push    word ptr [bx+digshapes]
    call    far ptr sprite_putimage_or
    add     sp, 0x8
    mov     byte ptr [bp+var_1C], 0x1
LAB_21b7_187a:
    mov     ax, si
    cwd
    mov     cx, 0xa
    idiv    cx
    mov     word ptr [bp+var_8], ax
    or      ax, ax
    jnz     LAB_21b7_188f
    cmp     byte ptr [bp+var_1C], 0x0
    jz      LAB_21b7_18c3
LAB_21b7_188f:
    mov     al, byte ptr [simd_player.(spdpoints+3)]
    sub     ah, ah
    push    ax
    mov     al, byte ptr [simd_player.(spdpoints+2)]
    push    ax
    mov     bx, word ptr [bp+var_8]
    shl     bx, 0x1
    shl     bx, 0x1
    push    word ptr [bx+digshapes+2]
    push    word ptr [bx+digshapes]
    call    far ptr sprite_putimage_or
    add     sp, 0x8
    mov     ax, word ptr [bp+var_8]
    mov     cx, ax
    shl     ax, 0x1
    shl     ax, 0x1
    add     ax, cx
    shl     ax, 0x1
    sub     si, ax
    mov     byte ptr [bp+var_1C], 0x1
LAB_21b7_18c3:
    mov     al, byte ptr [simd_player.(spdpoints+5)]
    sub     ah, ah
    push    ax
    mov     al, byte ptr [simd_player.(spdpoints+4)]
    push    ax
    mov     bx, si
    shl     bx, 0x1
    shl     bx, 0x1
    push    word ptr [bx+digshapes+2]
    push    word ptr [bx+digshapes]
    call    far ptr sprite_putimage_or
    add     sp, 0x8
    jmp     LAB_21b7_1915
    db 0x90
LAB_21b7_18e6:
    cmp     byte ptr [bp+var_6], 0x0
    jnz     LAB_21b7_1915
    mov     ax, si
    shl     ax, 0x1
    mov     word ptr [bp+var_20], ax
    push    word ptr [meter_needle_color]
    mov     bx, ax
    mov     al, byte ptr [bx+simd_player.(spdpoints+1)]
    sub     ah, ah
    push    ax
    mov     al, byte ptr [bx+simd_player.spdpoints]
    push    ax
    push    word ptr [simd_player.spdcenter.y2]
    push    word ptr [simd_player.spdcenter.x2]
    call    far ptr preRender_line
    add     sp, 0xa
LAB_21b7_1915:
    mov     ax, di
    shl     ax, 0x1
    mov     word ptr [bp+var_20], ax
    push    word ptr [meter_needle_color]
    mov     bx, ax
    mov     al, byte ptr [bx+simd_player.(revpoints+1)]
    sub     ah, ah
    push    ax
    mov     al, byte ptr [bx+simd_player.revpoints]
    push    ax
    push    word ptr [simd_player.revcenter.y2]
    push    word ptr [simd_player.revcenter.x2]
    call    far ptr preRender_line
    add     sp, 0xa
    mov     al, byte ptr [bp+var_2]
    cbw
    or      ax, ax
    jz      LAB_21b7_194e
    cmp     ax, 0x2                            ; st. whl. position flag
    jz      LAB_21b7_197c
    jmp     LAB_21b7_196e
    db 0x90
LAB_21b7_194e:
    push    word ptr [(whlshapes+7*4)+2]
    push    word ptr [(whlshapes+7*4)]
    call    far ptr shape2d_render_bmp_as_mask
    add     sp, 0x4
    push    word ptr [(whlshapes+5*4)+2]
    push    word ptr [(whlshapes+5*4)]
LAB_21b7_1966:
    call    far ptr shape2d_op_unk4
    add     sp, 0x4
LAB_21b7_196e:
    cmp     byte ptr [video_flag5_is0], 0x0
    jz      LAB_21b7_1996
    call    far ptr setup_mcgawnd2
    jmp     LAB_21b7_199b
LAB_21b7_197c:
    push    word ptr [(whlshapes+8*4)+2]
    push    word ptr [(whlshapes+8*4)]
    call    far ptr shape2d_render_bmp_as_mask
    add     sp, 0x4
    push    word ptr [(whlshapes+6*4)+2]
    push    word ptr [(whlshapes+6*4)]
    jmp     LAB_21b7_1966
LAB_21b7_1996:
    call    far ptr sprite_copy_2_to_1_2
LAB_21b7_199b:
    push    word ptr [height_above_replaybar]
    sub     ax, ax
    push    ax
    mov     ax, 0x140
    push    ax
    sub     ax, ax
    push    ax
    call    far ptr sprite_set_1_size
    add     sp, 0x8
    les     bx, [(whlshapes+3*4)]
    push    word ptr es:[bx+0xa]
    push    word ptr es:[bx+0x8]
    les     bx, [whlsprite1]
    push    word ptr es:[bx+0x2]
    push    word ptr es:[bx]
    call    far ptr sprite_putimage_and_alt
    add     sp, 0x8
LAB_21b7_19d0:
    mov     al, byte ptr [byte_4432A]
    cbw
    mov     bx, ax
    shl     bx, 0x1
    mov     ax, word ptr [bp+var_4]
    cmp     word ptr [bx+word_40E00], ax
    jnz     LAB_21b7_19f1
    cmp     byte ptr [byte_454A4], 0x0
    jnz     LAB_21b7_19f1
    cmp     byte ptr [bp+var_1A], 0x0
    jnz     LAB_21b7_19f1
    jmp     near ptr LAB_21b7_1b30
LAB_21b7_19f1:
    cmp     byte ptr [video_flag5_is0], 0x0
    jnz     LAB_21b7_19fd
    call    far ptr mouse_draw_opaque_check
LAB_21b7_19fd:
    push    word ptr [height_above_replaybar]
    sub     ax, ax
    push    ax
    mov     ax, 0x140
    push    ax
    sub     ax, ax
    push    ax
    call    far ptr sprite_set_1_size
    add     sp, 0x8
    mov     al, byte ptr [byte_4432A]
    cbw
    shl     ax, 0x1
    mov     word ptr [bp+var_20], ax
    mov     bx, ax
    cmp     word ptr [bx+word_40DF6], 0x0
    jz      LAB_21b7_1a55
    push    word ptr [bx+word_40DF6]
    push    word ptr [bx+word_40DF2]
    mov     al, byte ptr [byte_44346]
    cbw
    mov     bx, ax
    shl     bx, 0x1
    shl     bx, 0x1
    push    word ptr [bx+(gnobshapes+4*4)+2]
    push    word ptr [bx+(gnobshapes+4*4)]
    call    far ptr sprite_putimage_and_alt
    add     sp, 0x8
    mov     al, byte ptr [byte_4432A]
    cbw
    mov     bx, ax
    shl     bx, 0x1
    mov     word ptr [bx+word_40DF6], 0x0
LAB_21b7_1a55:
    cmp     word ptr [bp+var_4], 0x0
    jge     LAB_21b7_1a62
    mov     ax, word ptr [bp+var_4]
    neg     ax
    jmp     LAB_21b7_1a65
LAB_21b7_1a62:
    mov     ax, word ptr [bp+var_4]
LAB_21b7_1a65:
    shl     ax, 0x1
    add     ax, offset simd_player.steeringdots
    mov     word ptr [bp+var_E], ax
    mov     bx, ax
    mov     al, byte ptr [bx+0x1]
    mov     byte ptr [bp+var_16], al
    mov     al, byte ptr [bx]
    mov     byte ptr [bp+var_14], al
    cmp     word ptr [bp+var_4], 0x0
    jge     LAB_21b7_1a89
    sub     al, byte ptr [simd_player.steeringdots]
    shl     al, 0x1
    sub     byte ptr [bp+var_14], al
LAB_21b7_1a89:
    mov     al, byte ptr [byte_4432A]
    cbw
    shl     ax, 0x1
    mov     word ptr [bp+var_20], ax
    mov     al, byte ptr [bp+var_14]
    sub     ah, ah
    les     bx, [(gnobshapes+2*4)]
    sub     ax, word ptr es:[bx+0x4]
    and     ax, word ptr [video_flag3_isFFFF]
    mov     bx, word ptr [bp+var_20]
    mov     word ptr [bx+word_40DF2], ax
    mov     al, byte ptr [bp+var_16]
    sub     ah, ah
    les     bx, [(gnobshapes+2*4)]
    sub     ax, word ptr es:[bx+0x6]
    mov     bx, word ptr [bp+var_20]
    mov     word ptr [bx+word_40DF6], ax
    mov     al, byte ptr [bp+var_16]
    sub     ah, ah
    les     bx, [(gnobshapes+2*4)]
    sub     ax, word ptr es:[bx+0x6]
    push    ax
    mov     bx, word ptr [bp+var_20]
    push    word ptr [bx+word_40DF2]
    mov     al, byte ptr [byte_44346]
    cbw
    mov     bx, ax
    shl     bx, 0x1
    shl     bx, 0x1
    push    word ptr [bx+(gnobshapes+4*4)+2]
    push    word ptr [bx+(gnobshapes+4*4)]
    call    far ptr sprite_clear_shape_alt
    add     sp, 0x8
    mov     al, byte ptr [bp+var_16]
    sub     ah, ah
    push    ax
    mov     al, byte ptr [bp+var_14]
    push    ax
    push    word ptr [(gnobshapes+3*4)+2]
    push    word ptr [(gnobshapes+3*4)]
    call    far ptr sprite_putimage_and_alt2
    add     sp, 0x8
    mov     al, byte ptr [bp+var_16]
    sub     ah, ah
    push    ax
    mov     al, byte ptr [bp+var_14]
    push    ax
    push    word ptr [(gnobshapes+2*4)+2]
    push    word ptr [(gnobshapes+2*4)]
    call    far ptr sprite_putimage_or_alt
    add     sp, 0x8
    mov     al, byte ptr [byte_4432A]
    cbw
    mov     bx, ax
    shl     bx, 0x1
    mov     ax, word ptr [bp+var_4]
    mov     word ptr [bx+word_40E00], ax
LAB_21b7_1b30:
    call    far ptr mouse_draw_transparent_check
    pop     si
    pop     di
    mov     sp, bp
    pop     bp
    retf
    db 0x90
LAB_21b7_1b3c:
    push    word ptr [whlsprite3+2]
    push    word ptr [whlsprite3]
    call    far ptr sprite_free_wnd
    add     sp, 0x4
    push    word ptr [whlsprite2+2]
    push    word ptr [whlsprite2]
    call    far ptr sprite_free_wnd
    add     sp, 0x4
    push    word ptr [whlsprite1+2]
    push    word ptr [whlsprite1]
    call    far ptr sprite_free_wnd
    add     sp, 0x4
    push    word ptr [stdbresptr+2]
    push    word ptr [stdbresptr]
    call    far ptr mmgr_free
    add     sp, 0x4
    push    word ptr [stdaresptr+2]
    push    word ptr [stdaresptr]
    call    far ptr mmgr_free
    add     sp, 0x4
    pop     si
    pop     di
    mov     sp, bp
    pop     bp
    retf
setup_car_shapes_asm_ endp

; int __cdecl16far setup_player_cars(void)
setup_player_cars_asm_ proc far
    var_8      = word ptr   -8
    var_6      = word ptr   -6
    var_4      = word ptr   -4
    var_2      = word ptr   -2

    push    bp
    mov     bp, sp
    sub     sp, 0x8
    sub     ax, ax
    mov     word ptr [wndsprite+2], ax
    mov     word ptr [wndsprite], ax
    mov     ax, 0x2
    push    ax
    call    far ptr ensure_file_exists
    add     sp, 0x2
    mov     ax, offset gameconfig.game_opponentcarid
    push    ax
    mov     ax, offset gameconfig
    push    ax
    call    far ptr shape3d_load_car_shapes
    add     sp, 0x4
    mov     al, byte ptr [gameconfig]
    mov     byte ptr [(aCarcoun+3)], al
    mov     al, byte ptr [gameconfig.(game_playercarid+1)]
    mov     byte ptr [(aCarcoun+4)], al
    mov     al, byte ptr [gameconfig.(game_playercarid+2)]
    mov     byte ptr [(aCarcoun+5)], al
    mov     al, byte ptr [gameconfig.(game_playercarid+3)]
    mov     byte ptr [(aCarcoun+6)], al
    mov     ax, offset aCarcoun
    push    ax
    call    far ptr file_load_resfile
    add     sp, 0x2
    mov     word ptr [bp+var_4], ax
    mov     word ptr [bp+var_2], dx
    sub     ax, ax
    push    ax
    push    dx
    push    word ptr [bp+var_4]
    call    far ptr setup_aero_trackdata
    add     sp, 0x6
    push    word ptr [bp+var_2]
    push    word ptr [bp+var_4]
    call    far ptr unload_resource
    add     sp, 0x4
    cmp     byte ptr [gameconfig.game_opponenttype], 0x0
    jz      LAB_21b7_1c63
    mov     al, byte ptr [gameconfig.game_opponentcarid]
    mov     byte ptr [(aCarcoun+3)], al
    mov     al, byte ptr [gameconfig.(game_opponentcarid+1)]
    mov     byte ptr [(aCarcoun+4)], al
    mov     al, byte ptr [gameconfig.(game_opponentcarid+2)]
    mov     byte ptr [(aCarcoun+5)], al
    mov     al, byte ptr [gameconfig.(game_opponentcarid+3)]
    mov     byte ptr [(aCarcoun+6)], al
    mov     ax, offset aCarcoun
    push    ax
    call    far ptr file_load_resfile
    add     sp, 0x2
    mov     word ptr [bp+var_4], ax
    mov     word ptr [bp+var_2], dx
    mov     ax, 0x1
    push    ax
    push    dx
    push    word ptr [bp+var_4]
    call    far ptr setup_aero_trackdata
    add     sp, 0x6
    push    word ptr [bp+var_2]
    push    word ptr [bp+var_4]
    call    far ptr unload_resource
    add     sp, 0x4
    mov     ax, 0x4
    push    ax
    call    far ptr ensure_file_exists
    add     sp, 0x2
    call    far ptr load_opponent_data
LAB_21b7_1c63:
    mov     ax, 0x3
    push    ax
    call    far ptr ensure_file_exists
    add     sp, 0x2
    mov     ax, offset aEng1
    push    ax                                 ; char *
    mov     ax, 0x5
    push    ax                                 ; int
    call    far ptr file_load_resource
    add     sp, 0x4
    mov     word ptr [eng1ptr], ax
    mov     word ptr [eng1ptr+2], dx
    mov     ax, offset aEng
    push    ax                                 ; char *
    mov     ax, 0x6
    push    ax                                 ; int
    call    far ptr file_load_resource
    add     sp, 0x4
    mov     word ptr [engptr], ax
    mov     word ptr [engptr+2], dx
    call    far ptr audio_add_driver_timer
    push    word ptr [engptr+2]
    push    word ptr [engptr]
    push    word ptr [eng1ptr+2]
    push    word ptr [eng1ptr]
    mov     ax, offset unk_3E7FC
    push    ds
    push    ax
    mov     ax, 0x21
    push    ax
    call    far ptr audio_init_engine
    add     sp, 0xe
    mov     word ptr [word_43964], ax
    mov     byte ptr [byte_459D8], 0x0
    mov     byte ptr [byte_42D26], 0x0
    mov     byte ptr [byte_42D2A], 0x0
    cmp     byte ptr [gameconfig.game_opponenttype], 0x0
    jz      LAB_21b7_1d00
    push    word ptr [engptr+2]
    push    word ptr [engptr]
    push    word ptr [eng1ptr+2]
    push    word ptr [eng1ptr]
    mov     ax, offset unk_3E82C
    push    ds
    push    ax
    mov     ax, 0x20
    push    ax
    call    far ptr audio_init_engine
    add     sp, 0xe
    mov     word ptr [word_4408C], ax
LAB_21b7_1d00:
    mov     word ptr [word_44D1E], 0x0
    mov     word ptr [word_449E4], 0x0
    mov     word ptr [word_443F4], 0x0
    mov     ax, offset aFontled_fnt
    push    ax                                 ; char *
    sub     ax, ax
    push    ax                                 ; int
    call    far ptr file_load_resource
    add     sp, 0x4
    mov     word ptr [fontledresptr], ax
    mov     word ptr [fontledresptr+2], dx
    mov     ax, word ptr [slow_video_mgmt]
    mov     word ptr [slow_video_mgmt_copy], ax
    call    far ptr init_rect_arrays
    cmp     byte ptr [idle_expired], 0x0
    jnz     LAB_21b7_1d44
    sub     ax, ax
    push    ax
    push    cs
    call    near ptr setup_car_shapes
    add     sp, 0x2
LAB_21b7_1d44:
    cmp     byte ptr [idle_expired], 0x0
    jnz     LAB_21b7_1d6e
    mov     ax, offset aSdgame
    push    ax                                 ; char *
    mov     ax, 0x3
    push    ax                                 ; int
    call    far ptr file_load_resource
    add     sp, 0x4
    mov     word ptr [sdgameresptr], ax
    mov     word ptr [sdgameresptr+2], dx
    sub     ax, ax
    push    ax
    push    ax
    push    ax
    push    cs
    call    near ptr loop_game
    add     sp, 0x6
LAB_21b7_1d6e:
    mov     ax, offset aGame
    push    ax
    call    far ptr file_load_resfile
    add     sp, 0x2
    mov     word ptr [gameresptr], ax
    mov     word ptr [gameresptr+2], dx
    mov     ax, offset aPlan
    push    ax
    push    dx
    push    word ptr [gameresptr]
    call    far ptr locate_shape_alt
    add     sp, 0x6
    mov     word ptr [planptr], ax
    mov     word ptr [planptr+2], dx
    mov     ax, offset aWall
    push    ax
    push    word ptr [gameresptr+2]
    push    word ptr [gameresptr]
    call    far ptr locate_shape_alt
    add     sp, 0x6
    mov     word ptr [wallptr], ax
    mov     word ptr [wallptr+2], dx
    call    far ptr load_sdgame2_shapes
    les     bx, [td14_elem_map_main]
    mov     al, byte ptr es:[bx+0x384]         ; 384h = sky box position in track data
    sub     ah, ah
    push    ax
    call    far ptr load_skybox
    add     sp, 0x2
    call    far ptr shape3d_load_all
    or      ax, ax
    jz      LAB_21b7_1dde
LAB_21b7_1dd6:
    mov     ax, 0x1
    mov     sp, bp
    pop     bp
    retf
    db 0x90
LAB_21b7_1dde:
    cmp     byte ptr [video_flag5_is0], 0x0
    jnz     LAB_21b7_1e33
    mov     ax, word ptr [video_flag1_is1]
    imul    word ptr [video_flag4_is1]
    cwd
    push    dx
    push    ax
    mov     ax, 0xfa00
    sub     dx, dx
    push    dx
    push    ax
    call    far ptr __aFldiv
    add     ax, 0x12
    adc     dx, 0x0
    mov     word ptr [bp+var_8], ax
    mov     word ptr [bp+var_6], dx
    call    far ptr mmgr_get_res_ofs_diff_scaled
    cmp     dx, word ptr [bp+var_6]
    jg      LAB_21b7_1e18
    jl      LAB_21b7_1dd6
    cmp     ax, word ptr [bp+var_8]
    jbe     LAB_21b7_1dd6
LAB_21b7_1e18:
    mov     ax, 0xf
    push    ax
    mov     ax, 0xc8
    push    ax
    mov     ax, 0x140
    push    ax
    call    far ptr sprite_make_wnd
    add     sp, 0x6
    mov     word ptr [wndsprite], ax
    mov     word ptr [wndsprite+2], dx
LAB_21b7_1e33:
    mov     byte ptr [followOpponentFlag], 0x0
    mov     byte ptr [is_in_replay_copy], 0xff
    sub     ax, ax
    mov     sp, bp
    pop     bp
    retf
setup_player_cars_asm_ endp
    db 0x90

; void __cdecl16far free_player_cars(void)
free_player_cars_asm_ proc far
    cmp     byte ptr [video_flag5_is0], 0x0
    jnz     LAB_21b7_1e64
    mov     ax, word ptr [wndsprite]
    or      ax, word ptr [wndsprite+2]
    jz      LAB_21b7_1e64
    push    word ptr [wndsprite+2]
    push    word ptr [wndsprite]
    call    far ptr sprite_free_wnd
    add     sp, 0x4
LAB_21b7_1e64:
    call    far ptr shape3d_free_all
    call    far ptr unload_skybox
    call    far ptr free_sdgame2
    push    word ptr [gameresptr+2]
    push    word ptr [gameresptr]
    call    far ptr unload_resource
    add     sp, 0x4
    cmp     byte ptr [idle_expired], 0x0
    jnz     LAB_21b7_1ea5
    push    word ptr [sdgameresptr+2]
    push    word ptr [sdgameresptr]
    call    far ptr mmgr_free
    add     sp, 0x4
    mov     ax, 0x3
    push    ax
    push    cs
    call    near ptr setup_car_shapes
    add     sp, 0x2
LAB_21b7_1ea5:
    push    word ptr [fontledresptr+2]
    push    word ptr [fontledresptr]
    call    far ptr mmgr_free
    add     sp, 0x4
    call    far ptr audio_remove_driver_timer
    push    word ptr [engptr+2]
    push    word ptr [engptr]
    call    far ptr mmgr_free
    add     sp, 0x4
    push    word ptr [eng1ptr+2]
    push    word ptr [eng1ptr]
    call    far ptr mmgr_free
    add     sp, 0x4
    call    far ptr shape3d_free_car_shapes
    retf
free_player_cars_asm_ endp

; void __cdecl16far mouse_minmax_position(int is_driving)
mouse_minmax_position_asm_ proc far
    is_driving = word ptr    6

    push    bp
    mov     bp, sp
    cmp     word ptr [bp+is_driving], 0x0
    jz      LAB_21b7_1f12
    mov     ax, 0xc8
    push    ax
    mov     ax, 0x131
    push    ax
    sub     ax, ax
    push    ax
    mov     ax, 0xf
    push    ax
    call    far ptr mouse_set_minmax
    add     sp, 0x8
    mov     ax, 0x64
    push    ax
    mov     ax, 0xa0
    push    ax
    call    far ptr mouse_set_position
    add     sp, 0x4
    pop     bp
    retf
LAB_21b7_1f12:
    mov     ax, 0xc8
    push    ax
    mov     ax, 0x140
    push    ax
    sub     ax, ax
    push    ax
    push    ax
    call    far ptr mouse_set_minmax
    add     sp, 0x8
    pop     bp
    retf
mouse_minmax_position_asm_ endp

; void __cdecl16far replay_unk(void)
replay_unk_asm_ proc far
    var_A      = byte ptr  -10
    var_8      = byte ptr   -8
    var_6      = byte ptr   -6

    push    bp
    mov     bp, sp
    sub     sp, 0xa
    push    di
    push    si
    mov     si, word ptr [state.game_frame]
    and     si, 0x3f
    cmp     byte ptr [si+byte_442EA], 0x0
    jnz     LAB_21b7_1f41
    jmp     near ptr LAB_21b7_1fd5
LAB_21b7_1f41:
    mov     al, byte ptr [si+byte_44292]
    cbw
    mov     di, ax
    mov     ax, word ptr [state.playerstate.car_speed2]
    mov     cl, 0xa
    shr     ax, cl
    and     al, 0xfc
    mov     byte ptr [bp+var_8], al
    cbw
    mov     bx, ax
    add     bx, word ptr [steerWhlRespTable_ptr]
    mov     al, byte ptr [bx+0x1]
    mov     byte ptr [bp+var_A], al
    cmp     word ptr [state.playerstate.car_steeringAngle], di
    jge     LAB_21b7_1f70
    cmp     word ptr [state.playerstate.car_steeringAngle], -0x1
    jge     LAB_21b7_1f82
    jmp     LAB_21b7_1f7d
LAB_21b7_1f70:
    cmp     word ptr [state.playerstate.car_steeringAngle], di
    jle     LAB_21b7_1f82
    cmp     word ptr [state.playerstate.car_steeringAngle], 0x1
    jle     LAB_21b7_1f82
LAB_21b7_1f7d:
    mov     cl, 0x2
    shl     byte ptr [bp+var_A], cl
LAB_21b7_1f82:
    cmp     word ptr [state.playerstate.car_steeringAngle], di
    jle     LAB_21b7_1f9c
    mov     al, byte ptr [bp+var_A]
    cbw
    mov     cx, word ptr [state.playerstate.car_steeringAngle]
    sub     cx, ax
    cmp     cx, di
    jl      LAB_21b7_1f9c
    mov     byte ptr [bp+var_6], 0x8
    jmp     LAB_21b7_1fb8
LAB_21b7_1f9c:
    cmp     word ptr [state.playerstate.car_steeringAngle], di
    jge     LAB_21b7_1fb4
    mov     al, byte ptr [bp+var_A]
    cbw
    add     ax, word ptr [state.playerstate.car_steeringAngle]
    cmp     ax, di
    jg      LAB_21b7_1fb4
    mov     byte ptr [bp+var_6], 0x4
    jmp     LAB_21b7_1fb8
LAB_21b7_1fb4:
    mov     byte ptr [bp+var_6], 0x0
LAB_21b7_1fb8:
    cmp     byte ptr [bp+var_6], 0x0
    jz      LAB_21b7_1fd0
    mov     bx, word ptr [state.game_frame]
    add     bx, word ptr [td16_rpl_buffer]
    mov     es, word ptr [td16_rpl_buffer+2]
    mov     al, byte ptr [bp+var_6]
    or      byte ptr es:[bx], al               ; writing action into rpl buff?!
LAB_21b7_1fd0:
    mov     byte ptr [si+byte_442EA], 0x0
LAB_21b7_1fd5:
    pop     si
    pop     di
    mov     sp, bp
    pop     bp
    retf
replay_unk_asm_ endp
    db 0x90

; word * __cdecl16far loop_game(word * param_1, uint param_2, int param_3, byte * param_4, int param_5)
loop_game_asm_ proc far
    var_44     = word ptr  -68
    var_42     = word ptr  -66
    var_40     = byte ptr  -64
    var_3E     = byte ptr  -62
    var_3D     = byte ptr  -61
    var_3C     = byte ptr  -60
    var_3B     = byte ptr  -59
    var_38     = byte ptr  -56
    var_37     = byte ptr  -55
    var_36     = byte ptr  -54
    var_35     = byte ptr  -53
    var_34     = byte ptr  -52
    var_24     = word ptr  -36
    var_22     = word ptr  -34
    var_counter = byte ptr  -32
    var_1E     = byte ptr  -30
    var_18     = word ptr  -24
    var_inputcode = word ptr  -22
    var_14     = byte ptr  -20
    var_12     = word ptr  -18
    var_10     = word ptr  -16
    var_E      = word ptr  -14
    var_C      = word ptr  -12
    var_A      = word ptr  -10
    var_4      = word ptr   -4
    var_2      = byte ptr   -2
    param_1    = dword ptr   6
    param_2    = word ptr   10
    param_3    = word ptr   12
    param_4    = word ptr   14
    param_5    = word ptr   16

    push    bp
    mov     bp, sp
    sub     sp, 0x44
    push    di
    push    si
    mov     ax, word ptr [bp+param_1]
    or      ax, ax
    jz      LAB_21b7_2000
    cmp     ax, 0x1
    jz      LAB_21b7_2036
    cmp     ax, 0x2
    jz      LAB_21b7_201d
    cmp     ax, 0x3
    jnz     LAB_21b7_1ffd
    jmp     near ptr LAB_21b7_2448
LAB_21b7_1ffd:
    jmp     near ptr LAB_21b7_31ee
LAB_21b7_2000:
    mov     ax, offset rplyshapes
    push    ax
    mov     ax, offset aRplyrpicrpacrpmcrptcbof6bof5b
    push    ax
    push    word ptr [sdgameresptr+2]
    push    word ptr [sdgameresptr]
    call    far ptr locate_many_resources
    add     sp, 0x8
    mov     word ptr [bp+param_1+2], 0x4
LAB_21b7_201d:
    sub     si, si
LAB_21b7_201f:
    mov     byte ptr [si+byte_40E6A], 0x0
    inc     si
    cmp     si, 0x9
    jl      LAB_21b7_201f
    mov     bx, word ptr [bp+param_1+2]
    mov     byte ptr [bx+byte_40E6A], 0x1
    jmp     near ptr LAB_21b7_31ee
    db 0x90
LAB_21b7_2036:
    mov     al, byte ptr [byte_4432A]
    cbw
    mov     word ptr [bp+var_42], ax
    mov     bx, ax
    cmp     byte ptr [bx+byte_449D8], 0x0
    jz      LAB_21b7_2049
    jmp     near ptr LAB_21b7_20f6
LAB_21b7_2049:
    mov     byte ptr [bx+byte_449D8], 0x1
    mov     bx, word ptr [bp+var_42]
    mov     byte ptr [bx+byte_40E74], 0xff
    mov     bx, word ptr [bp+var_42]
    mov     byte ptr [bx+byte_40E08], 0xff
    sub     si, si
LAB_21b7_2060:
    mov     al, byte ptr [byte_4432A]
    cbw
    mov     bx, ax
    mov     ax, si
    shl     ax, 0x1
    add     bx, ax
    mov     byte ptr [bx+byte_40E7A], 0x0
    inc     si
    cmp     si, 0x9
    jl      LAB_21b7_2060
    call    far ptr mouse_draw_opaque_check
    push    word ptr [rplyshapes+2]
    push    word ptr [rplyshapes]
    call    far ptr shape2d_op_unk
    add     sp, 0x4
    mov     al, byte ptr [byte_4432A]
    cbw
    shl     ax, 0x1
    mov     word ptr [bp+var_42], ax
    mov     bx, ax
    mov     word ptr [bx+word_40E0A], 0xffff
    mov     bx, word ptr [bp+var_42]
    mov     word ptr [bx+word_40E76], 0xffff
    mov     ax, 0x1
    push    ax                                 ; int
    mov     ax, word ptr [gameconfig.game_recordedframes]
    add     ax, word ptr [elapsed_time1]
    push    ax
    mov     ax, offset g_res_id
    push    ax                                 ; char *
    call    far ptr format_frame_as_string
    add     sp, 0x6
    sub     ax, ax
    push    ax
    push    word ptr [dialog_fnt_colour]
    call    far ptr font_set_colour
    add     sp, 0x4
    push    word ptr [fontledresptr+2]
    push    word ptr [fontledresptr]
    call    far ptr font_set_fontdef2
    add     sp, 0x4
    mov     ax, 0xbb
    push    ax
    mov     ax, 0xd8
    push    ax
    mov     ax, offset g_res_id
    push    ax
    call    far ptr sub_345BC
    add     sp, 0x6
    call    far ptr font_set_fontdef
LAB_21b7_20f6:
    mov     ax, word ptr [bp+param_2]
    add     ax, word ptr [elapsed_time1]
    mov     word ptr [bp+var_42], ax
    mov     al, byte ptr [byte_4432A]
    cbw
    shl     ax, 0x1
    add     ax, offset word_40E0A
    mov     word ptr [bp+var_44], ax
    mov     bx, ax
    mov     ax, word ptr [bp+var_42]
    cmp     word ptr [bx], ax
    jz      LAB_21b7_2167
    mov     word ptr [bx], ax
    mov     ax, 0x1
    push    ax                                 ; int
    push    word ptr [bp+var_42]
    mov     ax, offset g_res_id
    push    ax                                 ; char *
    call    far ptr format_frame_as_string
    add     sp, 0x6
    sub     ax, ax
    push    ax
    push    word ptr [dialog_fnt_colour]
    call    far ptr font_set_colour
    add     sp, 0x4
    call    far ptr mouse_draw_opaque_check
    push    word ptr [fontledresptr+2]
    push    word ptr [fontledresptr]
    call    far ptr font_set_fontdef2
    add     sp, 0x4
    mov     ax, 0xbb
    push    ax
    mov     ax, 0x98
    push    ax
    mov     ax, offset g_res_id
    push    ax
    call    far ptr sub_345BC
    add     sp, 0x6
    call    far ptr font_set_fontdef
LAB_21b7_2167:
    mov     al, byte ptr [byte_4432A]
    cbw
    mov     word ptr [bp+var_44], ax
    mov     bx, ax
    mov     al, byte ptr [cameramode]
    cmp     byte ptr [bx+byte_40E74], al
    jz      LAB_21b7_21d6
    mov     byte ptr [bx+byte_40E74], al
    mov     bx, word ptr [bp+var_44]
    shl     bx, 0x1
    mov     word ptr [bx+word_40E76], 0xffff
    call    far ptr mouse_draw_opaque_check
    mov     al, byte ptr [cameramode]
    cbw
    mov     bx, ax
    shl     bx, 0x1
    shl     bx, 0x1
    push    word ptr [bx+(rplyshapes+1*4)+2]
    push    word ptr [bx+(rplyshapes+1*4)]
    call    far ptr shape2d_op_unk
    add     sp, 0x4
    mov     al, byte ptr [cameramode]
    cbw
    mov     bx, ax
    mov     al, byte ptr [bx+game_camera_buttons_count]
    mov     byte ptr [bp+var_42], al
    mov     al, byte ptr [byte_3E9DB]
    cmp     byte ptr [bp+var_42], al
    jge     LAB_21b7_21c2
    mov     al, byte ptr [bp+var_42]
    mov     byte ptr [byte_3E9DB], al
LAB_21b7_21c2:
    mov     al, byte ptr [byte_4432A]
    cbw
    add     ax, offset byte_40E08
    mov     word ptr [bp+var_44], ax
    mov     bx, ax
    cmp     byte ptr [bx], 0x6
    jle     LAB_21b7_21d6
    mov     byte ptr [bx], 0xff
LAB_21b7_21d6:
    cmp     word ptr [gameconfig.game_recordedframes], 0x0
    jnz     LAB_21b7_21e4
    sub     si, si
    sub     di, di
    jmp     LAB_21b7_2224
    db 0x90
LAB_21b7_21e4:
    mov     ax, word ptr [gameconfig.game_recordedframes]
    cwd
    push    dx
    push    ax
    mov     ax, 0x6e
    cwd
    push    dx
    push    ax
    mov     ax, word ptr [bp+param_1+2]
    cwd
    push    dx
    push    ax
    call    far ptr __aFlmul
    push    dx
    push    ax
    call    far ptr __aFldiv
    mov     si, ax
    mov     ax, word ptr [gameconfig.game_recordedframes]
    cwd
    push    dx
    push    ax
    mov     ax, 0x6e
    cwd
    push    dx
    push    ax
    mov     ax, word ptr [bp+param_2]
    cwd
    push    dx
    push    ax
    call    far ptr __aFlmul
    push    dx
    push    ax
    call    far ptr __aFldiv
    mov     di, ax
LAB_21b7_2224:
    mov     al, byte ptr [byte_4432A]
    cbw
    shl     ax, 0x1
    mov     word ptr [bp+var_44], ax
    mov     bx, ax
    cmp     word ptr [bx+word_40E76], si
    jnz     LAB_21b7_223b
    cmp     word ptr [bx+word_40E04], di
    jz      LAB_21b7_22aa
LAB_21b7_223b:
    call    far ptr mouse_draw_opaque_check
    mov     al, byte ptr [byte_4432A]
    cbw
    shl     ax, 0x1
    mov     word ptr [bp+var_44], ax
    mov     bx, ax
    mov     word ptr [bx+word_40E76], si
    mov     bx, word ptr [bp+var_44]
    mov     word ptr [bx+word_40E04], di
    push    word ptr [word_407FC]
    mov     ax, 0x6
    push    ax
    mov     ax, 0x74
    push    ax
    mov     ax, 0xb1
    push    ax
    mov     ax, 0x9a
    push    ax
    call    far ptr sprite_1_fill_rect
    add     sp, 0xa
    push    word ptr [dialog_fnt_colour]
    mov     ax, 0x6
    push    ax
    push    ax
    mov     ax, 0xb1
    push    ax
    lea     ax, [si+0x9a]
    push    ax
    call    far ptr sprite_1_fill_rect
    add     sp, 0xa
    push    word ptr [word_407FE]
    mov     ax, 0xb6
    push    ax
    lea     ax, [di+0x9f]
    push    ax
    mov     ax, 0xb1
    push    ax
    lea     ax, [di+0x9a]
    push    ax
    call    far ptr sprite_1_unk4
    add     sp, 0xa
LAB_21b7_22aa:
    mov     al, byte ptr [byte_4432A]
    cbw
    mov     bx, ax
    mov     al, byte ptr [byte_3E9DB]
    cmp     byte ptr [bx+byte_40E08], al
    jz      LAB_21b7_22f8
LAB_21b7_22b9:
    call    far ptr mouse_draw_opaque_check
    mov     al, byte ptr [byte_4432A]
    cbw
    mov     word ptr [bp+var_44], ax
    mov     bx, ax
    cmp     byte ptr [bx+byte_40E08], 0xff
    jnz     LAB_21b7_22d1
    jmp     near ptr LAB_21b7_2356
LAB_21b7_22d1:
    mov     al, byte ptr [bx+byte_40E08]
    cbw
    mov     word ptr [bp+var_42], ax
    mov     bx, ax
    shl     bx, 0x1
    add     bx, word ptr [bp+var_44]
    cmp     byte ptr [bx+byte_40E7A], 0x0
    jz      LAB_21b7_232a
    mov     bx, ax
    shl     bx, 0x1
    shl     bx, 0x1
    push    word ptr [bx+(rplyshapes+14*4)+2]
    push    word ptr [bx+(rplyshapes+14*4)]
    jmp     LAB_21b7_2343
    db 0x90
LAB_21b7_22f8:
    mov     byte ptr [bp+var_counter], 0x0
    jmp     LAB_21b7_2301
LAB_21b7_22fe:
    inc     byte ptr [bp+var_counter]
LAB_21b7_2301:
    cmp     byte ptr [bp+var_counter], 0x7
    jl      LAB_21b7_230a
    jmp     near ptr LAB_21b7_2440
LAB_21b7_230a:
    mov     al, byte ptr [bp+var_counter]
    cbw
    mov     word ptr [bp+var_44], ax
    mov     bx, ax
    mov     al, byte ptr [bx+byte_40E6A]
    mov     cx, ax
    mov     al, byte ptr [byte_4432A]
    cbw
    shl     bx, 0x1
    add     bx, ax
    cmp     byte ptr [bx+byte_40E7A], cl
    jz      LAB_21b7_22fe
    jmp     LAB_21b7_22b9
    db 0x90
LAB_21b7_232a:
    mov     al, byte ptr [byte_4432A]
    cbw
    mov     bx, ax
    mov     al, byte ptr [bx+byte_40E08]
    cbw
    mov     bx, ax
    shl     bx, 0x1
    shl     bx, 0x1
    push    word ptr [bx+(rplyshapes+5*4)+2]
    push    word ptr [bx+(rplyshapes+5*4)]
LAB_21b7_2343:
    call    far ptr shape2d_op_unk
    add     sp, 0x4
    mov     al, byte ptr [byte_4432A]
    cbw
    mov     bx, ax
    mov     byte ptr [bx+byte_40E08], 0xff
LAB_21b7_2356:
    mov     byte ptr [bp+var_counter], 0x0
LAB_21b7_235a:
    mov     al, byte ptr [bp+var_counter]
    cbw
    mov     word ptr [bp+var_44], ax
    mov     bx, ax
    cmp     byte ptr [bx+byte_40E6A], 0x0
    jnz     LAB_21b7_23a8
    mov     al, byte ptr [bx+byte_40E6A]
    mov     cx, ax
    mov     al, byte ptr [byte_4432A]
    cbw
    shl     bx, 0x1
    add     bx, ax
    cmp     byte ptr [bx+byte_40E7A], cl
    jz      LAB_21b7_23a8
    mov     bx, word ptr [bp+var_44]
    shl     bx, 0x1
    shl     bx, 0x1
    push    word ptr [bx+(rplyshapes+5*4)+2]
    push    word ptr [bx+(rplyshapes+5*4)]
    call    far ptr shape2d_op_unk
    add     sp, 0x4
    mov     al, byte ptr [bp+var_counter]
    cbw
    mov     bx, ax
    shl     bx, 0x1
    mov     al, byte ptr [byte_4432A]
    cbw
    add     bx, ax
    mov     byte ptr [bx+byte_40E7A], 0x0
LAB_21b7_23a8:
    inc     byte ptr [bp+var_counter]
    cmp     byte ptr [bp+var_counter], 0x7
    jl      LAB_21b7_235a
    mov     byte ptr [bp+var_counter], 0x0
LAB_21b7_23b5:
    mov     al, byte ptr [bp+var_counter]
    cbw
    mov     word ptr [bp+var_44], ax
    mov     bx, ax
    cmp     byte ptr [bx+byte_40E6A], 0x0
    jz      LAB_21b7_23fc
    mov     al, byte ptr [byte_4432A]
    cbw
    shl     bx, 0x1
    add     bx, ax
    mov     byte ptr [bx+byte_40E7A], 0x1
    mov     bx, word ptr [bp+var_44]
    shl     bx, 0x1
    shl     bx, 0x1
    push    word ptr [bx+(rplyshapes+14*4)+2]
    push    word ptr [bx+(rplyshapes+14*4)]
    call    far ptr shape2d_op_unk
    add     sp, 0x4
    mov     al, byte ptr [bp+var_counter]
    cbw
    mov     bx, ax
    shl     bx, 0x1
    mov     al, byte ptr [byte_4432A]
    cbw
    add     bx, ax
    mov     byte ptr [bx+byte_40E7A], 0x1
LAB_21b7_23fc:
    inc     byte ptr [bp+var_counter]
    cmp     byte ptr [bp+var_counter], 0x7
    jl      LAB_21b7_23b5
    mov     al, byte ptr [byte_4432A]
    cbw
    mov     bx, ax
    mov     al, byte ptr [byte_3E9DB]
    mov     byte ptr [bx+byte_40E08], al
    cmp     byte ptr [byte_3E9DB], 0xff
    jz      LAB_21b7_2440
    mov     al, byte ptr [byte_3E9DB]
    cbw
    shl     ax, 0x1
    mov     word ptr [bp+var_44], ax
    push    word ptr [word_407FE]
    mov     bx, ax
    push    word ptr [bx+game_camera_buttons_y2]
    push    word ptr [bx+game_camera_buttons_x2]
    push    word ptr [bx+game_camera_buttons_y1]
    push    word ptr [bx+game_camera_buttons_x1]
    call    far ptr sprite_1_unk4
    add     sp, 0xa
LAB_21b7_2440:
    call    far ptr mouse_draw_transparent_check
    jmp     near ptr LAB_21b7_31ee
LAB_21b7_2448:
    mov     al, byte ptr [cameramode]
    cbw
    mov     bx, ax
    mov     al, byte ptr [bx+game_camera_buttons_count]
    mov     byte ptr [bp+var_44], al
    mov     al, byte ptr [byte_3E9DB]
    cmp     byte ptr [bp+var_44], al
    jge     LAB_21b7_246a
    cmp     byte ptr [cameramode], 0x2
    jz      LAB_21b7_246a
    mov     al, byte ptr [bp+var_44]
    mov     byte ptr [byte_3E9DB], al
LAB_21b7_246a:
    call    far ptr sprite_copy_2_to_1
    cmp     byte ptr [video_flag5_is0], 0x0
    jz      LAB_21b7_247e
    mov     al, byte ptr [byte_44346]
    xor     al, 0x1
    mov     byte ptr [byte_4432A], al
LAB_21b7_247e:
    call    far ptr timer_get_delta_alt
    push    ax
    call    far ptr input_checking
    add     sp, 0x2
    mov     word ptr [bp+var_inputcode], ax
    mov     ax, offset game_camera_buttons_y2
    push    ax
    mov     ax, offset game_camera_buttons_y1
    push    ax
    mov     ax, offset game_camera_buttons_x2
    push    ax
    mov     ax, offset game_camera_buttons_x1
    push    ax
    mov     al, byte ptr [cameramode]
    cbw
    mov     bx, ax
    mov     al, byte ptr [bx+game_camera_buttons_count] ; get number of buttons by cameramode
    cbw
    inc     ax
    push    ax
    call    far ptr mouse_multi_hittest
    add     sp, 0xa
    mov     byte ptr [bp+var_counter], al
    cmp     al, 0xff
    jnz     LAB_21b7_24be
    jmp     near ptr LAB_21b7_2568
LAB_21b7_24be:
    mov     al, byte ptr [byte_3E9DB]
    cmp     byte ptr [bp+var_counter], al
    jz      LAB_21b7_24d1
    cmp     word ptr [bp+var_inputcode], 0x0
    jnz     LAB_21b7_24d1
    mov     word ptr [bp+var_inputcode], 0x1
LAB_21b7_24d1:
    mov     al, byte ptr [bp+var_counter]
    mov     byte ptr [byte_3E9DB], al
    cmp     word ptr [bp+var_inputcode], 0x20
    jz      LAB_21b7_24e6
    cmp     word ptr [bp+var_inputcode], 0xd
    jz      LAB_21b7_24e6
    jmp     near ptr LAB_21b7_259c
LAB_21b7_24e6:
    cmp     byte ptr [byte_3E9DB], 0x7
    jge     LAB_21b7_24f0
    jmp     near ptr LAB_21b7_259c
LAB_21b7_24f0:
    jnz     LAB_21b7_2512
    mov     ax, word ptr [word_3EA3A]
    add     ax, word ptr [word_3EA4C]
    sar     ax, 0x1
    cmp     ax, word ptr [mouse_ypos]
    jge     LAB_21b7_250a
LAB_21b7_2501:
    mov     word ptr [bp+var_inputcode], 0x5000
    jmp     near ptr LAB_21b7_259c
    db 0x90
LAB_21b7_250a:
    mov     word ptr [bp+var_inputcode], 0x4800
    jmp     near ptr LAB_21b7_259c
LAB_21b7_2512:
    mov     ax, word ptr [word_3EA3C]
    add     ax, word ptr [word_3EA4E]
    sar     ax, 0x1
    sub     ax, word ptr [mouse_ypos]
    push    ax
    mov     ax, word ptr [mouse_xpos]
    mov     cx, word ptr [word_3EA18]
    add     cx, word ptr [word_3EA2A]
    sar     cx, 0x1
    sub     ax, cx
    push    ax
    call    far ptr polarAngle
    add     sp, 0x4
    add     ax, 0x80
    and     ah, 0x3
    mov     cl, 0x8
    shr     ax, cl
    or      ax, ax
    jz      LAB_21b7_250a
    cmp     ax, 0x1
    jz      LAB_21b7_2558
    cmp     ax, 0x2
    jz      LAB_21b7_2501
    cmp     ax, 0x3
    jz      LAB_21b7_2560
    jmp     LAB_21b7_259c
    db 0x90
LAB_21b7_2558:
    mov     word ptr [bp+var_inputcode], 0x4d00
    jmp     LAB_21b7_259c
    db 0x90
LAB_21b7_2560:
    mov     word ptr [bp+var_inputcode], 0x4b00
    jmp     LAB_21b7_259c
    db 0x90
LAB_21b7_2568:
    mov     ax, offset gameunk_button_y2
    push    ax
    mov     ax, offset gameunk_button_y1
    push    ax
    mov     ax, offset gameunk_button_x2
    push    ax
    mov     ax, offset gameunk_button_x1
    push    ax
    mov     ax, 0x1
    push    ax
    call    far ptr mouse_multi_hittest
    add     sp, 0xa
    mov     byte ptr [bp+var_counter], al
    or      al, al
    jnz     LAB_21b7_259c
    cmp     word ptr [bp+var_inputcode], 0x20
    jz      LAB_21b7_2597
    cmp     word ptr [bp+var_inputcode], 0xd
    jnz     LAB_21b7_259c
LAB_21b7_2597:
    mov     word ptr [bp+var_inputcode], 0x63
LAB_21b7_259c:
    cmp     word ptr [bp+var_inputcode], 0x0
    jz      LAB_21b7_25b9
    cmp     word ptr [bp+var_inputcode], 0x1b
    jz      LAB_21b7_25b9
    push    word ptr [bp+var_inputcode]
    push    cs
    call    near ptr handle_ingame_kb_shortcuts
    add     sp, 0x2
    or      al, al
    jz      LAB_21b7_25b9
    jmp     near ptr LAB_21b7_31ee
LAB_21b7_25b9:
    cmp     byte ptr [is_in_replay], 0x0
    jnz     LAB_21b7_25ea
    cmp     word ptr [bp+var_inputcode], 0x0
    jnz     LAB_21b7_25ea
    cmp     byte ptr [replaybar_enabled], 0x0
    jnz     LAB_21b7_25d0
    jmp     near ptr LAB_21b7_31ee
LAB_21b7_25d0:
    push    word ptr [state.game_frame]
    push    word ptr [state.game_frame]
    mov     ax, 0x1
    push    ax
    push    cs
    call    near ptr loop_game
    add     sp, 0x6
    pop     si
    pop     di
    mov     sp, bp
    pop     bp
    retf
    db 0x90
LAB_21b7_25ea:
    cmp     byte ptr [replaybar_enabled], 0x0
    jnz     LAB_21b7_25fc
    mov     byte ptr [is_in_replay_copy], 0xff
    mov     word ptr [word_449EA], 0xffff
LAB_21b7_25fc:
    cmp     byte ptr [is_in_replay], 0x0
    jz      LAB_21b7_2623
    cmp     byte ptr [byte_40E6D], 0x0
    jnz     LAB_21b7_2611
    cmp     byte ptr [byte_40E6C], 0x0
    jz      LAB_21b7_2623
LAB_21b7_2611:
    sub     ax, ax
    push    ax
    mov     ax, 0x4
    push    ax
    mov     ax, 0x2
    push    ax
    push    cs
    call    near ptr loop_game
    add     sp, 0x6
LAB_21b7_2623:
    push    word ptr [state.game_frame]
    push    word ptr [state.game_frame]
    mov     ax, 0x1
    push    ax
    push    cs
    call    near ptr loop_game
    add     sp, 0x6
    mov     byte ptr [bp+var_40], 0x0
    mov     ax, 0x1d
    push    ax
    call    far ptr kb_get_key_state
    add     sp, 0x2
    or      ax, ax
    jnz     LAB_21b7_2658
    cmp     byte ptr [byte_3E9DB], 0x8
    jnz     LAB_21b7_265c
    test    byte ptr [kbjoyflags], 0x30
    jz      LAB_21b7_265c
LAB_21b7_2658:
    mov     byte ptr [bp+var_40], 0x1
LAB_21b7_265c:
    cmp     byte ptr [bp+var_40], 0x0
    jz      LAB_21b7_268e
    mov     ax, word ptr [bp+var_inputcode]
    cmp     ax, 0x2b
    jnz     LAB_21b7_266d
    jmp     near ptr LAB_21b7_272c
LAB_21b7_266d:
    cmp     ax, 0x2d
    jnz     LAB_21b7_2675
    jmp     near ptr LAB_21b7_26fe
LAB_21b7_2675:
    cmp     ax, 0x4800
    jz      LAB_21b7_26d2
    cmp     ax, 0x4b00
    jz      LAB_21b7_26c6
    cmp     ax, 0x4d00
    jz      LAB_21b7_26ba
    cmp     ax, 0x5000
    jz      LAB_21b7_26e8
LAB_21b7_2689:
    mov     word ptr [bp+var_inputcode], 0x0
LAB_21b7_268e:
    mov     ax, word ptr [bp+var_inputcode]
    cmp     ax, 0x2b
    jnz     LAB_21b7_2699
    jmp     near ptr LAB_21b7_272c
LAB_21b7_2699:
    jbe     LAB_21b7_269e
    jmp     near ptr LAB_21b7_31c2
LAB_21b7_269e:
    cmp     ax, 0xd
    jnz     LAB_21b7_26a6
    jmp     near ptr LAB_21b7_27c4
LAB_21b7_26a6:
    cmp     ax, 0x1b
    jnz     LAB_21b7_26ae
    jmp     near ptr LAB_21b7_27d6
LAB_21b7_26ae:
    cmp     ax, 0x20
    jnz     LAB_21b7_26b6
    jmp     near ptr LAB_21b7_27c4
LAB_21b7_26b6:
    jmp     near ptr LAB_21b7_2777
    db 0x90
LAB_21b7_26ba:
    add     word ptr [word_3B8EE], 0x10
    pop     si
    pop     di
    mov     sp, bp
    pop     bp
    retf
    db 0x90
LAB_21b7_26c6:
    sub     word ptr [word_3B8EE], 0x10
    pop     si
    pop     di
    mov     sp, bp
    pop     bp
    retf
    db 0x90
LAB_21b7_26d2:
    mov     ax, word ptr [word_3B8F0]
    add     ax, 0x10
    cmp     ax, 0x100
    jge     LAB_21b7_2689
    add     word ptr [word_3B8F0], 0x10
    pop     si
    pop     di
    mov     sp, bp
    pop     bp
    retf
LAB_21b7_26e8:
    mov     ax, word ptr [word_3B8F0]
    sub     ax, 0x10
    cmp     ax, 0xff00
    jle     LAB_21b7_2689
    sub     word ptr [word_3B8F0], 0x10
    pop     si
    pop     di
    mov     sp, bp
    pop     bp
    retf
LAB_21b7_26fe:
    cmp     byte ptr [cameramode], 0x3
    jnz     LAB_21b7_2718
    cmp     word ptr [word_44D20], 0x0
    jg      LAB_21b7_270f
    jmp     near ptr LAB_21b7_2689
LAB_21b7_270f:
    sub     word ptr [word_44D20], 0x1e
    jmp     near ptr LAB_21b7_31ee
    db 0x90
LAB_21b7_2718:
    cmp     word ptr [word_3B8EC], 0x5dc
    jl      LAB_21b7_2723
    jmp     near ptr LAB_21b7_2689
LAB_21b7_2723:
    add     word ptr [word_3B8EC], 0x1e
    jmp     near ptr LAB_21b7_31ee
    db 0x90
LAB_21b7_272c:
    cmp     byte ptr [cameramode], 0x3
    jnz     LAB_21b7_2746
    cmp     word ptr [word_44D20], 0x384
    jl      LAB_21b7_273e
    jmp     near ptr LAB_21b7_2689
LAB_21b7_273e:
    add     word ptr [word_44D20], 0x1e
    jmp     near ptr LAB_21b7_31ee
LAB_21b7_2746:
    cmp     word ptr [word_3B8EC], 0x78
    jg      LAB_21b7_2750
    jmp     near ptr LAB_21b7_2689
LAB_21b7_2750:
    sub     word ptr [word_3B8EC], 0x1e
    jmp     near ptr LAB_21b7_31ee
LAB_21b7_2758:
    mov     al, byte ptr [byte_3E9DB]
    cbw
    mov     bx, ax
    mov     al, byte ptr [bx+byte_3E9DC]
    mov     byte ptr [bp+var_44], al
    mov     al, byte ptr [cameramode]
    cbw
    mov     bx, ax
    mov     al, byte ptr [bp+var_44]
    cmp     byte ptr [bx+game_camera_buttons_count], al
    jl      LAB_21b7_2777
LAB_21b7_2774:
    mov     byte ptr [byte_3E9DB], al
LAB_21b7_2777:
    push    word ptr [state.game_frame]
    push    word ptr [state.game_frame]
    mov     ax, 0x1
    push    ax
    push    cs
    call    near ptr loop_game
    add     sp, 0x6
    jmp     near ptr LAB_21b7_247e
    db 0x90
LAB_21b7_278e:
    mov     al, byte ptr [byte_3E9DB]
    cbw
    mov     bx, ax
    mov     al, byte ptr [bx+byte_3E9E6]
    jmp     LAB_21b7_2774
LAB_21b7_279a:
    cmp     byte ptr [byte_3E9DB], 0x7
    jz      LAB_21b7_272c
    mov     al, byte ptr [byte_3E9DB]
    cbw
    mov     bx, ax
    mov     al, byte ptr [bx+byte_3E9F0]
    jmp     LAB_21b7_2774
    db 0x90
LAB_21b7_27ae:
    cmp     byte ptr [byte_3E9DB], 0x7
    jnz     LAB_21b7_27b8
    jmp     near ptr LAB_21b7_26fe
LAB_21b7_27b8:
    mov     al, byte ptr [byte_3E9DB]
    cbw
    mov     bx, ax
    mov     al, byte ptr [bx+byte_3E9FA]
    jmp     LAB_21b7_2774
LAB_21b7_27c4:
    mov     al, byte ptr [byte_3E9DB]
    cbw
    cmp     ax, 0x6
    ja      LAB_21b7_2777
    add     ax, ax
    xchg    ax, bx
    jmp     word ptr cs:[bx+off_24D20]
    db 0x90
LAB_21b7_27d6:
    mov     byte ptr [is_in_replay], 0x1
    call    far ptr audio_carstate
    sub     ax, ax
    push    ax
    mov     ax, 0x4
    push    ax
    mov     ax, 0x2
    push    ax
    push    cs
    call    near ptr loop_game
    add     sp, 0x6
    push    word ptr [state.game_frame]
    push    word ptr [state.game_frame]
    mov     ax, 0x1
    push    ax
    push    cs
    call    near ptr loop_game
    add     sp, 0x6
    sub     si, si
LAB_21b7_2807:
    mov     bx, si
    shl     bx, 0x1
    add     bx, bp
    mov     word ptr [bx-0x14], 0x0
    inc     si
    cmp     si, 0x8
    jl      LAB_21b7_2807
    cmp     byte ptr [state.playerstate.car_crashBmpFlag], 0x0
    jz      LAB_21b7_2824
    mov     word ptr [bp+var_E], 0x1
LAB_21b7_2824:
    cmp     word ptr [gameconfig.game_recordedframes], 0x0
    jz      LAB_21b7_2832
    cmp     word ptr [elapsed_time1], 0x0
    jz      LAB_21b7_2837
LAB_21b7_2832:
    mov     word ptr [bp+var_A], 0x1
LAB_21b7_2837:
    cmp     byte ptr [passed_security], 0x0
    jnz     LAB_21b7_2848
    mov     word ptr [bp+var_10], 0x1
    mov     word ptr [bp+var_E], 0x1
LAB_21b7_2848:
    test    byte ptr [byte_43966], 0x4
    jnz     LAB_21b7_2854
    mov     word ptr [bp+var_12], 0x1
LAB_21b7_2854:
    mov     al, byte ptr [video_flag6_is1]     ; pause menu
    mov     byte ptr [byte_454A4], al
    sub     ax, ax
    push    ax
    lea     ax, [bp+var_14]
    push    ax
    push    word ptr [dialogarg2]
    mov     ax, 0xffff
    push    ax
    push    ax
    mov     ax, offset aMen_0
    push    ax
    push    word ptr [gameresptr+2]
    push    word ptr [gameresptr]
    call    far ptr locate_text_res
    add     sp, 0x6
    push    dx
    push    ax
    sub     ax, ax
    push    ax
    mov     ax, 0x2
    push    ax
    call    far ptr show_dialog
    add     sp, 0x12
    mov     byte ptr [bp+var_2], al
    cbw
    sub     ax, 0x1
    cmp     ax, 0x6
    jbe     LAB_21b7_289e
    jmp     near ptr LAB_21b7_2cb8
LAB_21b7_289e:
    add     ax, ax
    xchg    ax, bx
    jmp     word ptr cs:[bx+off_2481A]
LAB_21b7_28a6:
    call    far ptr check_input
    mov     ax, word ptr [framespersec2]
    mov     word ptr [framespersec], ax
    mov     al, byte ptr [framespersec2]
    mov     byte ptr [gameconfig.game_framespersec], al
    mov     ax, 0xffff
    push    ax
    call    far ptr init_game_state
    add     sp, 0x2
    mov     word ptr [elapsed_time2], 0x0
    mov     word ptr [gameconfig.game_recordedframes], 0x0
    mov     byte ptr [word_45D3E], 0x0
    mov     byte ptr [byte_43966], 0x1
    jmp     LAB_21b7_2940
    db 0x90
LAB_21b7_28dc:
    test    byte ptr [byte_43966], 0x2
    jz      LAB_21b7_28ea
LAB_21b7_28e3:
    mov     byte ptr [byte_43966], 0x3
    jmp     LAB_21b7_2937
LAB_21b7_28ea:
    mov     ax, word ptr [elapsed_time2]
    cmp     word ptr [gameconfig.game_recordedframes], ax
    jz      LAB_21b7_2932
    sub     ax, ax
    push    ax
    push    ax
    push    word ptr [performGraphColor]
    mov     ax, 0xffff
    push    ax
    push    ax
    mov     ax, offset aCon_0                  ; RH warning
    push    ax
    push    word ptr [gameresptr+2]
    push    word ptr [gameresptr]
    call    far ptr locate_text_res
    add     sp, 0x6
    push    dx
    push    ax
    sub     ax, ax
    push    ax
    mov     ax, 0x2
    push    ax
    call    far ptr show_dialog
    add     sp, 0x12
    mov     si, ax
    cmp     si, 0x1
    jge     LAB_21b7_292f
    jmp     near ptr LAB_21b7_2cb8
LAB_21b7_292f:
    jmp     LAB_21b7_28e3
    db 0x90
LAB_21b7_2932:
    mov     byte ptr [byte_43966], 0x1
LAB_21b7_2937:
    mov     ax, word ptr [state.game_frame]
    mov     word ptr [elapsed_time2], ax
    mov     word ptr [gameconfig.game_recordedframes], ax
LAB_21b7_2940:
    mov     byte ptr [dashb_toggle], 0x1
    mov     byte ptr [show_penalty_counter], 0x0
    mov     byte ptr [followOpponentFlag], 0x0
    mov     byte ptr [game_replay_mode], 0x0
    mov     byte ptr [cameramode], 0x0
    mov     byte ptr [state.game_3F6autoLoadEvalFlag], 0x0
    mov     word ptr [state.game_frame_in_sec], 0x0
    mov     byte ptr [byte_449E6], 0x0
    sub     ax, ax
    push    ax
    mov     ax, 0x3
    push    ax
    mov     ax, 0x2
    push    ax
    push    cs
    call    near ptr loop_game
    add     sp, 0x6
    mov     byte ptr [is_in_replay], 0x0
    mov     al, byte ptr [byte_3B8F2]
    cbw
    push    ax
    push    cs
    call    near ptr mouse_minmax_position
    add     sp, 0x2
    call    far ptr check_input
    mov     byte ptr [kbormouse], 0x0
    jmp     near ptr LAB_21b7_2cb8
    db 0x90
LAB_21b7_299a:
    mov     byte ptr [byte_43966], 0x0
    call    far ptr audio_carstate
    mov     ax, offset aRep
    push    ax
    push    word ptr [mainresptr+2]
    push    word ptr [mainresptr]
    call    far ptr locate_text_res
    add     sp, 0x6
    push    dx                                 ; int
    push    ax                                 ; int
    mov     ax, offset a_rpl_1
    push    ax                                 ; int
    mov     ax, 0x140
    push    ax
    mov     ax, offset byte_3B85E
    push    ax                                 ; char *
    call    far ptr do_fileselect_dialog
    add     sp, 0xa
    cbw
    mov     si, ax
    or      si, si
    jnz     LAB_21b7_29d8
    jmp     near ptr LAB_21b7_2cb8
LAB_21b7_29d8:
    mov     word ptr [waitflag], 0x96
    call    far ptr show_waiting
    push    si
    push    di
    lea     di, [bp-0x3e]
    mov     si, offset gameconfig
    push    ss
    pop     es
    mov     cx, 0xd
    rep movsw
    pop     di
    pop     si
    les     bx, [td14_elem_map_main]
    mov     al, byte ptr es:[bx+0x384]
    sub     ah, ah
    mov     word ptr [bp-0x4], ax
    mov     ax, 0x140
    push    ax
    mov     ax, 0xee
    push    ax                                 ; char *
    push    cs
    call    near ptr file_load_replay
    add     sp, 0x4
    or      al, al
    jz      LAB_21b7_2a1b
    mov     word ptr [gameconfig.game_recordedframes], 0x0
LAB_21b7_2a1b:
    mov     byte ptr [dashb_toggle], 0x0
    call    far ptr track_setup
    sub     si, si
    les     bx, [td14_elem_map_main]
    mov     al, byte ptr es:[bx+0x384]
    sub     ah, ah
    cmp     ax, word ptr [bp-0x4]
    jz      LAB_21b7_2a3a
    mov     si, 0x1
LAB_21b7_2a3a:
    mov     al, byte ptr [gameconfig]
    cmp     byte ptr [bp-0x3e], al
    jnz     LAB_21b7_2a5a
    mov     al, byte ptr [gameconfig.(game_playercarid+1)]
    cmp     byte ptr [bp-0x3d], al
    jnz     LAB_21b7_2a5a
    mov     al, byte ptr [gameconfig.(game_playercarid+2)]
    cmp     byte ptr [bp-0x3c], al
    jnz     LAB_21b7_2a5a
    mov     al, byte ptr [gameconfig.(game_playercarid+3)]
    cmp     byte ptr [bp-0x3b], al
    jz      LAB_21b7_2a60
LAB_21b7_2a5a:
    mov     si, 0x1
    jmp     LAB_21b7_2a9d
    db 0x90
LAB_21b7_2a60:
    mov     al, byte ptr [gameconfig.game_opponenttype]
    cmp     byte ptr [bp-0x38], al
    jnz     LAB_21b7_2a5a
    or      al, al
    jz      LAB_21b7_2a9d
    mov     al, byte ptr [gameconfig.game_opponentcarid]
    cmp     byte ptr [bp-0x37], al
    jnz     LAB_21b7_2a5a
    mov     al, byte ptr [gameconfig.(game_opponentcarid+1)]
    cmp     byte ptr [bp-0x36], al
    jnz     LAB_21b7_2a5a
    mov     al, byte ptr [gameconfig.(game_opponentcarid+2)]
    cmp     byte ptr [bp-0x35], al
    jnz     LAB_21b7_2a5a
    mov     al, byte ptr [gameconfig.(game_opponentcarid+3)]
    cmp     byte ptr [bp-0x34], al
    jnz     LAB_21b7_2a5a
    mov     ax, 0x2
    push    ax
    call    far ptr ensure_file_exists
    add     sp, 0x2
    call    far ptr load_opponent_data
LAB_21b7_2a9d:
    or      si, si
    jz      LAB_21b7_2aa9
    push    cs
    call    near ptr free_player_cars
    push    cs
    call    near ptr setup_player_cars
LAB_21b7_2aa9:
    mov     al, byte ptr [gameconfig.game_framespersec]
    cbw
    mov     word ptr [framespersec], ax
    mov     ax, 0xffff
    push    ax
    call    far ptr init_game_state
    add     sp, 0x2
    jmp     near ptr LAB_21b7_2cb8
    db 0x90
LAB_21b7_2ac0:
    call    far ptr audio_carstate
LAB_21b7_2ac5:
    mov     byte ptr [bp-0x1e], 0x0
LAB_21b7_2ac9:
    cmp     byte ptr [bp-0x1e], 0x0
    jz      LAB_21b7_2ad2
    jmp     near ptr LAB_21b7_2cb8
LAB_21b7_2ad2:
    mov     ax, offset aRep_1
    push    ax
    push    word ptr [mainresptr+2]
    push    word ptr [mainresptr]
    call    far ptr locate_text_res
    add     sp, 0x6
    push    dx                                 ; int
    push    ax                                 ; int
    mov     ax, 0x140
    push    ax
    mov     ax, 0xee
    push    ax                                 ; char *
    call    far ptr do_savefile_dialog
    add     sp, 0x8
    or      al, al
    jnz     LAB_21b7_2aff
    jmp     near ptr LAB_21b7_2b80
LAB_21b7_2aff:
    mov     ax, offset g_path_buf
    push    ax                                 ; char *
    mov     ax, offset a_rpl_2
    push    ax                                 ; int
    mov     ax, 0x140
    push    ax
    mov     ax, 0xee
    push    ax                                 ; char *
    call    far ptr file_build_path
    add     sp, 0x8
    mov     byte ptr [bp-0x1e], 0x1
    mov     byte ptr [g_is_busy], 0x1
    mov     ax, offset g_path_buf
    push    ax
    call    far ptr file_find
    add     sp, 0x2
    or      ax, ax
    jz      LAB_21b7_2b78
    sub     ax, ax
    push    ax
    push    ax
    push    word ptr [performGraphColor]
    mov     ax, 0xffff
    push    ax
    push    ax
    mov     ax, offset aFex_0
    push    ax
    push    word ptr [mainresptr+2]
    push    word ptr [mainresptr]
    call    far ptr locate_text_res
    add     sp, 0x6
    push    dx
    push    ax
    sub     ax, ax
    push    ax
    mov     ax, 0x2
    push    ax
    call    far ptr show_dialog
    add     sp, 0x12
    mov     si, ax
    cmp     si, -0x1
    jnz     LAB_21b7_2b70
    mov     byte ptr [bp-0x1e], 0xff
    jmp     LAB_21b7_2b78
    db 0x90
LAB_21b7_2b70:
    or      si, si
    jnz     LAB_21b7_2b78
    mov     byte ptr [bp-0x1e], 0x0
LAB_21b7_2b78:
    mov     byte ptr [g_is_busy], 0x0
    jmp     LAB_21b7_2b84
    db 0x90
LAB_21b7_2b80:
    mov     byte ptr [bp-0x1e], 0xff
LAB_21b7_2b84:
    cmp     byte ptr [bp-0x1e], 0x1
    jz      LAB_21b7_2b8d
    jmp     near ptr LAB_21b7_2ac9
LAB_21b7_2b8d:
    mov     ax, offset g_path_buf
    push    ax
    push    cs
    call    near ptr file_write_replay
    add     sp, 0x2
    mov     byte ptr [bp-0x20], al
    or      al, al
    jnz     LAB_21b7_2ba2
    jmp     near ptr LAB_21b7_2ac9
LAB_21b7_2ba2:
    sub     ax, ax
    push    ax
    push    ax
    push    word ptr [performGraphColor]
    mov     ax, 0xffff
    push    ax
    push    ax
    mov     ax, offset aSer_0
    push    ax
    push    word ptr [mainresptr+2]
    push    word ptr [mainresptr]
    call    far ptr locate_text_res
    add     sp, 0x6
    push    dx
    push    ax
    sub     ax, ax
    push    ax
    mov     ax, 0x1
    push    ax
    call    far ptr show_dialog
    add     sp, 0x12
    jmp     near ptr LAB_21b7_2ac5
    db 0x90
LAB_21b7_2bd8:
    sub     ax, ax
    push    ax
    mov     ax, 0x4
    push    ax
    call    far ptr update_crash_state
    add     sp, 0x4
LAB_21b7_2be7:
    mov     byte ptr [byte_449DA], 0x2
    jmp     near ptr LAB_21b7_2cb8
    db 0x90
LAB_21b7_2bf0:
    sub     ax, ax
    push    ax
    mov     ax, 0x4
    push    ax
    call    far ptr update_crash_state
    add     sp, 0x4
    mov     byte ptr [byte_43966], 0x0
    jmp     LAB_21b7_2be7
LAB_21b7_2c06:
    sub     si, si
LAB_21b7_2c08:
    mov     bx, si
    shl     bx, 0x1
    add     bx, bp
    mov     word ptr [bx-0x14], 0x0
    inc     si
    cmp     si, 0x5
    jl      LAB_21b7_2c08
    cmp     byte ptr [gameconfig.game_opponenttype], 0x0
    jnz     LAB_21b7_2c25
    mov     word ptr [bp-0xc], 0x1
LAB_21b7_2c25:
    sub     ax, ax
    push    ax
    lea     ax, [bp-0x14]
    push    ax
    push    word ptr [dialogarg2]
    mov     ax, 0xffff
    push    ax
    push    ax
    mov     ax, offset aMdo
    push    ax
    push    word ptr [gameresptr+2]
    push    word ptr [gameresptr]
    call    far ptr locate_text_res
    add     sp, 0x6
    push    dx
    push    ax
    sub     ax, ax
    push    ax
    mov     ax, 0x2
    push    ax
    call    far ptr show_dialog
    add     sp, 0x12
    mov     byte ptr [bp-0x2], al
    cbw
    or      ax, ax
    jz      LAB_21b7_2c78
    cmp     ax, 0x1
    jz      LAB_21b7_2c80
    cmp     ax, 0x2
    jz      LAB_21b7_2c88
    cmp     ax, 0x3
    jz      LAB_21b7_2c9a
    cmp     ax, 0x4
    jz      LAB_21b7_2ca2
    jmp     LAB_21b7_2cb8
LAB_21b7_2c78:
    xor     byte ptr [dashb_toggle], 0x1
    jmp     LAB_21b7_2cb8
    db 0x90
LAB_21b7_2c80:
    xor     byte ptr [replaybar_toggle], 0x1   ; "replay bar on/off (while driving)"
    jmp     LAB_21b7_2cb8
    db 0x90
LAB_21b7_2c88:
    inc     byte ptr [cameramode]
    cmp     byte ptr [cameramode], 0x4
    jnz     LAB_21b7_2cb8
    mov     byte ptr [cameramode], 0x0
    jmp     LAB_21b7_2cb8
LAB_21b7_2c9a:
    call    far ptr show_graphic_levels_menu
    jmp     LAB_21b7_2cb8
    db 0x90
LAB_21b7_2ca2:
    xor     byte ptr [followOpponentFlag], 0x1
    jmp     LAB_21b7_2cb8
    db 0x90
off_2481A:
    dw LAB_21b7_2bd8
    dw LAB_21b7_28a6
    dw LAB_21b7_28dc                           ; modifying this to 0x2CB8 disables Continue Driving
    dw LAB_21b7_299a
    dw LAB_21b7_2ac0
    dw LAB_21b7_2c06
    dw LAB_21b7_2bf0
LAB_21b7_2cb8:
    call    far ptr check_input
    jmp     near ptr LAB_21b7_31ee
LAB_21b7_2cc0:
    mov     byte ptr [is_in_replay], 0x1
    call    far ptr audio_carstate
    sub     ax, ax
    push    ax
    push    ax
    mov     ax, 0x2
    push    ax
    push    cs
    call    near ptr loop_game
    add     sp, 0x6
    call    far ptr timer_get_delta_alt
    mov     word ptr [bp-0x24], 0x14
    mov     word ptr [bp-0x22], 0x0
    jmp     near ptr LAB_21b7_2d84
    db 0x90
LAB_21b7_2cec:
    mov     ax, 0x32
    cwd
    push    dx
    push    ax
    push    word ptr [bp-0x22]
    push    word ptr [bp-0x24]
    call    far ptr __aFldiv
    mov     di, ax
    add     di, 0x3
    cmp     di, 0x64
    jle     LAB_21b7_2d0a
    mov     di, 0x64
LAB_21b7_2d0a:
    call    far ptr timer_get_delta_alt
    mov     word ptr [bp-0x18], ax
    imul    di
    mov     si, ax
    cwd
    add     word ptr [bp-0x24], ax
    adc     word ptr [bp-0x22], dx
    mov     ax, word ptr [gameconfig.game_recordedframes]
    sub     ax, word ptr [elapsed_time2]
    mov     word ptr [bp-0x44], ax
    mov     ax, 0x14
    cwd
    push    dx
    push    ax
    push    word ptr [bp-0x22]
    push    word ptr [bp-0x24]
    call    far ptr __aFldiv
    cmp     ax, word ptr [bp-0x44]
    jbe     LAB_21b7_2d54
    mov     ax, 0x14
    cwd
    push    dx
    push    ax
    sub     ax, ax
    push    ax
    push    word ptr [bp-0x44]
    call    far ptr __aFlmul
    mov     word ptr [bp-0x24], ax
    mov     word ptr [bp-0x22], dx
LAB_21b7_2d54:
    mov     ax, 0x14
    cwd
    push    dx
    push    ax
    push    word ptr [bp-0x22]
    push    word ptr [bp-0x24]
    call    far ptr __aFldiv
    add     ax, word ptr [elapsed_time2]
    push    ax
    push    word ptr [state.game_frame]
    mov     ax, 0x1
    push    ax
    push    cs
    call    near ptr loop_game
    add     sp, 0x6
    push    word ptr [bp-0x18]
    call    far ptr input_do_checking
    add     sp, 0x2
LAB_21b7_2d84:
    test    byte ptr [kbjoyflags], 0x30
    jz      LAB_21b7_2d8e
    jmp     near ptr LAB_21b7_2cec
LAB_21b7_2d8e:
    mov     ax, word ptr [gameconfig.game_recordedframes]
    sub     ax, word ptr [elapsed_time2]
    mov     word ptr [bp-0x44], ax
    mov     ax, 0x14
    cwd
    push    dx
    push    ax
    push    word ptr [bp-0x22]
    push    word ptr [bp-0x24]
    call    far ptr __aFldiv
    cmp     ax, word ptr [bp-0x44]
    jbe     LAB_21b7_2dc5
    mov     ax, 0x14
    cwd
    push    dx
    push    ax
    sub     ax, ax
    push    ax
    push    word ptr [bp-0x44]
    call    far ptr __aFlmul
    mov     word ptr [bp-0x24], ax
    mov     word ptr [bp-0x22], dx
LAB_21b7_2dc5:
    mov     ax, 0x14
    cwd
    push    dx
    push    ax
    push    word ptr [bp-0x22]
    push    word ptr [bp-0x24]
    call    far ptr __aFldiv
    mov     si, ax
    add     si, word ptr [elapsed_time2]
    cmp     word ptr [gameconfig.game_recordedframes], si
    jge     LAB_21b7_2de6
    mov     si, word ptr [gameconfig.game_recordedframes]
LAB_21b7_2de6:
    push    si
    call    far ptr restore_gamestate
    add     sp, 0x2
    mov     word ptr [elapsed_time2], si
    sub     ax, ax
    push    ax
    mov     ax, 0x4
    push    ax
    mov     ax, 0x2
    push    ax
    push    cs
    call    near ptr loop_game
    add     sp, 0x6
    mov     ax, offset aWai_0
    push    ax
    push    word ptr [gameresptr+2]
    push    word ptr [gameresptr]
    call    far ptr locate_text_res
    add     sp, 0x6
    push    dx
    push    ax
    mov     ax, offset g_res_id
    push    ax
    call    far ptr copy_string
    add     sp, 0x6
    cmp     word ptr [slow_video_mgmt_copy], 0x0
    jz      LAB_21b7_2e62
    push    word ptr [rectptr_unk2]
    sub     ax, ax
    push    ax
    push    word ptr [dialog_fnt_colour]
    mov     ax, 0x64
    push    ax
    mov     ax, offset g_res_id
    push    ax
    call    far ptr font_op2_alt
    add     sp, 0x2
    push    ax
    mov     ax, offset g_res_id
    push    ax
    call    far ptr intro_draw_text
    add     sp, 0xa
    push    ax
    push    word ptr [rectptr_unk2]
    call    far ptr rect_union
    jmp     LAB_21b7_2e9d
LAB_21b7_2e62:
    sub     ax, ax
    push    ax
    push    word ptr [dialog_fnt_colour]
    mov     ax, 0x64
    push    ax
    mov     ax, offset g_res_id
    push    ax
    call    far ptr font_op2_alt
    add     sp, 0x2
    push    ax
    mov     ax, offset g_res_id
    push    ax
    call    far ptr intro_draw_text
    add     sp, 0xa
    jmp     LAB_21b7_2ea0
LAB_21b7_2e88:
    call    far ptr update_gamestate
    push    word ptr [elapsed_time2]
    push    word ptr [state.game_frame]
    mov     ax, 0x1
    push    ax
    push    cs
    call    near ptr loop_game
LAB_21b7_2e9d:
    add     sp, 0x6
LAB_21b7_2ea0:
    mov     ax, word ptr [elapsed_time2]
    cmp     word ptr [state.game_frame], ax
    jnz     LAB_21b7_2e88
LAB_21b7_2ea9:
    mov     ax, 0x3e8
    push    ax
    call    far ptr input_do_checking
    add     sp, 0x2
    jmp     near ptr LAB_21b7_31ee
LAB_21b7_2eb8:
    mov     byte ptr [is_in_replay], 0x1
    call    far ptr audio_carstate
    sub     ax, ax
    push    ax
    mov     ax, 0x1
    push    ax
    mov     ax, 0x2
    push    ax
    push    cs
    call    near ptr loop_game
    add     sp, 0x6
    call    far ptr timer_get_delta_alt
    mov     word ptr [bp-0x24], 0x14
    mov     word ptr [bp-0x22], 0x0
    jmp     near ptr LAB_21b7_2f7a
    db 0x90
    db 0x90
LAB_21b7_2ee8:
    mov     ax, 0x32
    cwd
    push    dx
    push    ax
    push    word ptr [bp-0x22]
    push    word ptr [bp-0x24]
    call    far ptr __aFldiv
    mov     di, ax
    add     di, 0x3
    cmp     di, 0x64
    jle     LAB_21b7_2f06
    mov     di, 0x64
LAB_21b7_2f06:
    call    far ptr timer_get_delta_alt
    mov     word ptr [bp-0x18], ax
    imul    di
    mov     si, ax
    cwd
    add     word ptr [bp-0x24], ax
    adc     word ptr [bp-0x22], dx
    mov     ax, 0x14
    cwd
    push    dx
    push    ax
    push    word ptr [bp-0x22]
    push    word ptr [bp-0x24]
    call    far ptr __aFldiv
    cmp     ax, word ptr [elapsed_time2]
    jbe     LAB_21b7_2f48
    mov     ax, 0x14
    cwd
    push    dx
    push    ax
    sub     ax, ax
    push    ax
    push    word ptr [elapsed_time2]
    call    far ptr __aFlmul
    mov     word ptr [bp-0x24], ax
    mov     word ptr [bp-0x22], dx
LAB_21b7_2f48:
    mov     ax, 0x14
    cwd
    push    dx
    push    ax
    push    word ptr [bp-0x22]
    push    word ptr [bp-0x24]
    call    far ptr __aFldiv
    mov     cx, word ptr [elapsed_time2]
    sub     cx, ax
    push    cx
    push    word ptr [state.game_frame]
    mov     ax, 0x1
    push    ax
    push    cs
    call    near ptr loop_game
    add     sp, 0x6
    push    word ptr [bp-0x18]
    call    far ptr input_do_checking
    add     sp, 0x2
LAB_21b7_2f7a:
    test    byte ptr [kbjoyflags], 0x30
    jz      LAB_21b7_2f84
    jmp     near ptr LAB_21b7_2ee8
LAB_21b7_2f84:
    mov     ax, 0x14
    cwd
    push    dx
    push    ax
    push    word ptr [bp-0x22]
    push    word ptr [bp-0x24]
    call    far ptr __aFldiv
    cmp     ax, word ptr [elapsed_time2]
    jbe     LAB_21b7_2fb3
    mov     ax, 0x14
    cwd
    push    dx
    push    ax
    sub     ax, ax
    push    ax
    push    word ptr [elapsed_time2]
    call    far ptr __aFlmul
    mov     word ptr [bp-0x24], ax
    mov     word ptr [bp-0x22], dx
LAB_21b7_2fb3:
    mov     ax, 0x14
    cwd
    push    dx
    push    ax
    push    word ptr [bp-0x22]
    push    word ptr [bp-0x24]
    call    far ptr __aFldiv
    mov     di, ax
    sub     ax, ax
    push    ax
    mov     ax, 0x4
    push    ax
    mov     ax, 0x2
    push    ax
    push    cs
    call    near ptr loop_game
    add     sp, 0x6
    or      di, di
    jnz     LAB_21b7_2fdf
    jmp     near ptr LAB_21b7_30d3
LAB_21b7_2fdf:
    mov     ax, offset aWai_1
    push    ax
    push    word ptr [gameresptr+2]
    push    word ptr [gameresptr]
    call    far ptr locate_text_res
    add     sp, 0x6
    push    dx
    push    ax
    mov     ax, offset g_res_id
    push    ax
    call    far ptr copy_string
    add     sp, 0x6
    cmp     word ptr [slow_video_mgmt_copy], 0x0
    jz      LAB_21b7_3040
    push    word ptr [rectptr_unk2]
    sub     ax, ax
    push    ax
    push    word ptr [dialog_fnt_colour]
    mov     ax, 0x64
    push    ax
    mov     ax, offset g_res_id
    push    ax
    call    far ptr font_op2_alt
    add     sp, 0x2
    push    ax
    mov     ax, offset g_res_id
    push    ax
    call    far ptr intro_draw_text
    add     sp, 0xa
    push    ax
    push    word ptr [rectptr_unk2]
    call    far ptr rect_union
    add     sp, 0x6
    jmp     LAB_21b7_3064
    db 0x90
LAB_21b7_3040:
    sub     ax, ax
    push    ax
    push    word ptr [dialog_fnt_colour]
    mov     ax, 0x64
    push    ax
    mov     ax, offset g_res_id
    push    ax
    call    far ptr font_op2_alt
    add     sp, 0x2
    push    ax
    mov     ax, offset g_res_id
    push    ax
    call    far ptr intro_draw_text
    add     sp, 0xa
LAB_21b7_3064:
    mov     si, word ptr [elapsed_time2]
    sub     si, di
    push    si
    call    far ptr restore_gamestate
    add     sp, 0x2
    mov     word ptr [elapsed_time2], si
    mov     ax, si
    sub     ax, word ptr [state.game_frame]
    mov     word ptr [bp-0x4], ax
    or      ax, ax
    jz      LAB_21b7_30d3
    mov     si, ax
    jmp     LAB_21b7_30ca
LAB_21b7_3088:
    call    far ptr update_gamestate
    dec     si
    push    word ptr [elapsed_time2]
    mov     ax, word ptr [bp-0x4]
    cwd
    push    dx
    push    ax
    mov     ax, di
    cwd
    push    dx
    push    ax
    mov     ax, si
    cwd
    push    dx
    push    ax
    call    far ptr __aFlmul
    push    dx
    push    ax
    call    far ptr __aFldiv
    add     ax, word ptr [elapsed_time2]
    push    ax
    mov     ax, 0x1
    push    ax
    push    cs
    call    near ptr loop_game
    add     sp, 0x6
    mov     ax, 0x1
    push    ax
    call    far ptr input_do_checking
    add     sp, 0x2
LAB_21b7_30ca:
    mov     ax, word ptr [elapsed_time2]
    cmp     word ptr [state.game_frame], ax
    jnz     LAB_21b7_3088
LAB_21b7_30d3:
    push    word ptr [state.game_frame]
    push    word ptr [state.game_frame]
    mov     ax, 0x1
    push    ax
    push    cs
    call    near ptr loop_game
    add     sp, 0x6
    jmp     near ptr LAB_21b7_2ea9
    db 0x90
LAB_21b7_30ea:
    mov     byte ptr [byte_449E6], 0x0
    sub     ax, ax
    push    ax
    mov     ax, 0x3
    push    ax
    mov     ax, 0x2
    push    ax
    push    cs
    call    near ptr loop_game
    add     sp, 0x6
    jmp     near ptr LAB_21b7_31a8
LAB_21b7_3104:
    mov     byte ptr [is_in_replay], 0x1
    call    far ptr audio_carstate
    sub     ax, ax
    push    ax
    mov     ax, 0x4
    push    ax
    mov     ax, 0x2
    push    ax
    push    cs
    call    near ptr loop_game
    add     sp, 0x6
    push    word ptr [state.game_frame]
    push    word ptr [state.game_frame]
    mov     ax, 0x1
    push    ax
    push    cs
    call    near ptr loop_game
    add     sp, 0x6
    jmp     near ptr LAB_21b7_2777
LAB_21b7_3136:
    mov     byte ptr [is_in_replay], 0x1
    call    far ptr audio_carstate
    sub     ax, ax
    push    ax
    mov     ax, 0x5
    push    ax
    mov     ax, 0x2
    push    ax
    push    cs
    call    near ptr loop_game
    add     sp, 0x6
    push    word ptr [state.game_frame]
    push    word ptr [state.game_frame]
    mov     ax, 0x1
    push    ax
    push    cs
    call    near ptr loop_game
    add     sp, 0x6
    sub     ax, ax
    push    ax
    call    far ptr restore_gamestate
    add     sp, 0x2
    mov     ax, 0x32
    cwd
    push    dx
    push    ax
    call    far ptr timer_get_counter_unk
    add     sp, 0x4
    sub     ax, ax
    push    ax
    mov     ax, 0x4
    push    ax
    mov     ax, 0x2
    push    ax
    push    cs
    call    near ptr loop_game
    add     sp, 0x6
    jmp     near ptr LAB_21b7_25d0
    db 0x90
LAB_21b7_3194:
    sub     ax, ax
    push    ax
    mov     ax, 0x2
    push    ax
    push    ax
    push    cs
    call    near ptr loop_game
    add     sp, 0x6
    mov     byte ptr [byte_449E6], 0x3
LAB_21b7_31a8:
    mov     byte ptr [is_in_replay], 0x0
    jmp     near ptr LAB_21b7_2777
off_24D20:
    dw LAB_21b7_2cc0
    dw LAB_21b7_2eb8
    dw LAB_21b7_3194
    dw LAB_21b7_30ea
    dw LAB_21b7_3104
    dw LAB_21b7_3136
    dw LAB_21b7_27d6
    jmp     near ptr LAB_21b7_2777
    db 0x90
LAB_21b7_31c2:
    cmp     ax, 0x2d
    jnz     LAB_21b7_31ca
    jmp     near ptr LAB_21b7_26fe
LAB_21b7_31ca:
    cmp     ax, 0x4800
    jnz     LAB_21b7_31d2
    jmp     near ptr LAB_21b7_279a
LAB_21b7_31d2:
    cmp     ax, 0x4b00
    jnz     LAB_21b7_31da
    jmp     near ptr LAB_21b7_2758
LAB_21b7_31da:
    cmp     ax, 0x4d00
    jnz     LAB_21b7_31e2
    jmp     near ptr LAB_21b7_278e
LAB_21b7_31e2:
    cmp     ax, 0x5000
    jnz     LAB_21b7_31ea
    jmp     near ptr LAB_21b7_27ae
LAB_21b7_31ea:
    jmp     near ptr LAB_21b7_2777
    db 0x90
LAB_21b7_31ee:
    pop     si
    pop     di
    mov     sp, bp
    pop     bp
    retf
loop_game_asm_ endp

seg005 ends
end
